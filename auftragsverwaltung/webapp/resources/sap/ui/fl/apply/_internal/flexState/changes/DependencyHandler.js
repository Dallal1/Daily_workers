/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/Utils"],function(e,n){"use strict";var t="sap.ui.fl:PendingChange";var i={};function d(n,t){return e.getControlIdBySelector(n,t)}function c(e){return{changeObject:e,dependencies:[],controlsDependencies:[],dependentIds:[]}}function s(e,n,t){r(t,n,e);o(t,n)}function o(e,n){if(!e.aChanges.includes(n)){e.aChanges.push(n)}}function r(e,n,t){e.mChanges[t]||=[];if(!e.mChanges[t].includes(n)){e.mChanges[t].push(n)}}function a(e,n,t){var i=e.getSelector();if(i){if(i.id){s(d(i,n),e,t)}else{o(t,e)}}return t.aChanges}function p(e,n){return e.some(function(e){return e.id===n.id&&e.idIsLocal===n.idIsLocal})}function u(e,n,t,i,c,s,o){var r=t.getDependentSelectorList();n.some(function(n){if(p(r,n)){var a=d(n,c);var u=i&&s.indexOf(e)<s.indexOf(t);if(u){g(t,e,a,o,true)}else{g(e,t,a,o)}return true}})}function f(e,n,t,i){if(e.isValidForDependencyMap()){var d=e.getDependentSelectorList();h(e,d,n,i);var c=t.indexOf(e);var s=c<t.length-1;var o=t.slice();o.splice(c,1);o.reverse().forEach(function(c){if(c.isValidForDependencyMap()){u(e,d,c,s,n,t,i)}})}}function h(e,n,t,i){if(n.length){var s=n.map(function(e){return d(e,t)});if(!i.mDependencies[e.getId()]){i.mDependencies[e.getId()]=c(e)}i.mDependencies[e.getId()].controlsDependencies=s;s.forEach(function(n){i.mControlsWithDependencies[n]||=[];i.mControlsWithDependencies[n].push(e.getId())})}}function g(e,n,t,i,d){if(l(e,n,t,i,d)){i.mDependencies[e.getId()].dependencies.push(n.getId());if(!i.mDependencies[e.getId()].dependentIds.includes(t)){i.mDependencies[e.getId()].dependentIds.push(t)}if(!i.mDependentChangesOnMe[n.getId()]){i.mDependentChangesOnMe[n.getId()]=[]}i.mDependentChangesOnMe[n.getId()].push(e.getId())}}function l(e,n,t,i,d){var c=!d&&i.mDependencies[e.getId()].dependentIds.includes(t);var s=false;if(i.mDependentChangesOnMe[n.getId()]){i.mDependentChangesOnMe[n.getId()].some(function(n){s=i.mDependencies[e.getId()].dependencies.includes(n);return s})}return!c&&!s}function m(e,d){var c=[];var s=[];var o=[];if(e.dependencyRemovedInLastBatch[d]){e.dependencyRemovedInLastBatch[d].forEach(function(n){var i=e.mDependencies[n];if(i&&i.dependencies.length===0&&!(i.controlsDependencies&&i.controlsDependencies.length)){s.push(n);c.push(i.changeObject.getId());if(i[t]){o.push(function(){return i[t]()})}}})}return n.execPromiseQueueSequentially(o).then(function(n,t,d){delete e.dependencyRemovedInLastBatch[d];t.forEach(function(n){delete e.mDependencies[n]});n.forEach(function(n){i.resolveDependenciesForChange(e,n,d)});return!!n.length}.bind(undefined,c,s,d))}i.createEmptyDependencyMap=function(){return{aChanges:[],mChanges:{},mDependencies:{},mDependentChangesOnMe:{},mControlsWithDependencies:{},dependencyRemovedInLastBatch:{}}};i.addChangeAndUpdateDependencies=function(e,n,t){var i=a(e,n,t);f(e,n,i,t)};i.insertChange=function(e,n,t){var i=n&&n.aChanges&&n.aChanges.indexOf(t);if(i>-1){n.aChanges.splice(i+1,0,e)}};i.addRuntimeChangeToMap=function(e,n,t){a(e,n,t)};i.processDependentQueue=function(e,n,t){return m(e,t).then(function(t,d){if(d){return i.processDependentQueue(e,n,t)}}.bind(undefined,t))};i.addChangeApplyCallbackToDependency=function(e,n,i){e.mDependencies[n][t]=i};i.removeControlsDependencies=function(e,n){var t=e.mControlsWithDependencies[n];if(t){t.forEach(function(t){var i=e.mDependencies[t];if(i&&i.controlsDependencies&&i.controlsDependencies.length){var d=i.controlsDependencies.indexOf(n);if(d>-1){i.controlsDependencies.splice(d,1);delete e.mControlsWithDependencies[n];e.dependencyRemovedInLastBatch[n]||=[];if(!e.dependencyRemovedInLastBatch[n].includes(t)){e.dependencyRemovedInLastBatch[n].push(t)}}}});delete e.mControlsWithDependencies[n]}};i.resolveDependenciesForChange=function(e,n,t){var i=e.mDependentChangesOnMe[n];if(i){i.forEach(function(i){var d=e.mDependencies[i];var c=d?d.dependencies.indexOf(n):-1;if(c>-1){d.dependencies.splice(c,1);e.dependencyRemovedInLastBatch[t]||=[];if(!e.dependencyRemovedInLastBatch[t].includes(i)){e.dependencyRemovedInLastBatch[t].push(i)}}});delete e.mDependentChangesOnMe[n]}};i.removeChangeFromMap=function(e,n){Object.keys(e.mChanges).some(function(t){var i=e.mChanges[t];var d=i.map(function(e){return e.getId()}).indexOf(n);if(d!==-1){i.splice(d,1);return true}});var t=e.aChanges.map(function(e){return e.getId()}).indexOf(n);if(t!==-1){e.aChanges.splice(t,1)}};i.removeChangeFromDependencies=function(e,n,t){i.resolveDependenciesForChange(e,n,t);delete e.mDependencies[n]};i.getOpenDependentChangesForControl=function(n,t,i){var d=[];Object.keys(n.mDependencies).forEach(function(c){n.mDependencies[c].changeObject.getDependentSelectorList().forEach(function(s){if(e.getControlIdBySelector(s,i)===t){d.push(n.mDependencies[c].changeObject)}})});return d};return i});
//# sourceMappingURL=DependencyHandler.js.map