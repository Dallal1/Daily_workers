/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/each","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/appDescriptorChanges/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/compVariants/prepareCompVariantsMap","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/InitialPrepareFunctions","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/LayerUtils","sap/ui/fl/requireAsync"],function(e,t,n,r,a,i,c,s,o,f,u,p,l,d,m,g,h){"use strict";var b={};var x={};var O={};var v;var j={appDescriptorChanges:{prepareFunction:o,pathInResponse:[]},changes:{initialPreparationFunctionName:"uiChanges",pathInResponse:["changes"]},variants:{initialPreparationFunctionName:"variants",pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},compVariants:{prepareFunction:f,pathInResponse:["comp.variants","comp.standardVariants","comp.defaultVariants","comp.changes"]}};var y={compVariants:{},flexObjects:{}};function R(e,t){var n={comp(){return Object.values(t).reduce(function(e,t){return e.concat(t)},[])},variants(){return t.map(function(e){var n=e.variantReference===e.variantManagementReference||t.some(function(t){return t.variantManagementReference===e.variantManagementReference&&t.fileName===e.variantReference});if(!n){return Object.assign({},e,{variantReference:e.variantManagementReference})}return e})}}[e];if(n){return n()}return Array.isArray(t)?t:[]}function I(e){var t=i.getComponentById(e.componentId);e.componentData||=t&&t.getComponentData()||{};e.manifest||=e.rawManifest||t&&t.getManifestObject()||{};e.reference||=d.getFlexReference(e)}function F(e){var n=[];t(e.changes,function(e,t){R(e,t).forEach(function(e){n.push(c.createFromFileContent(e,null,true))})});return n}function S(e,t){var n=j[e].initialPreparationFunctionName;var r=p[n];if(r){return r(t)}return undefined}function D(e,t,n){t.reference=n;var r=S(e,t);if(r){V(n,r)}}var C=new u({id:"flexObjects",parameterKey:"reference",executeFunction(e,t){if(!x[t.reference]){return[]}var n=x[t.reference].runtimePersistence;return n.flexObjects.concat(n.runtimeOnlyData.flexObjects||[],y.flexObjects[t.reference][x[t.reference].componentId]||[])}});function P(e,t){if(!x[e]){throw new Error("State is not yet initialized")}if(!x[e].preparedMaps[t]){var n={unfilteredStorageResponse:x[e].unfilteredStorageResponse,storageResponse:x[e].storageResponse,componentId:x[e].componentId,componentData:x[e].componentData,reference:e,runtimePersistence:x[e].runtimePersistence};x[e].preparedMaps[t]=b.callPrepareFunction(t,n);D(t,n,e)}return x[e].preparedMaps[t]}function V(e,t){x[e]=n(x[e],t);C.checkUpdate({reference:e})}function _(e){return P(e,"appDescriptorChanges")}function M(e){return P(e,"compVariants")}function k(e,t){const r=e.storageResponse;var a={flexObjects:F(r),runtimeOnlyData:{flexObjects:[]}};Object.keys(j).forEach(function(i){var c=S(i,{storageResponse:r,externalData:t,flexObjects:a.flexObjects,componentId:e.componentId});if(c){a=n(a,c)}});return a}function w(e,n,r){var i=r.flexObjects.slice();var c=i.length;var o;var f=[];t(n.changes,function(e,t){R(e,t).forEach(function(e){f.push(e)})});x[e].runtimePersistence=Object.assign(r,{flexObjects:f.map(function(e){var t;var n=i.find(function(n,r){t=r;return n.getId()===e.fileName});if(n){i.splice(t,1);if(n.getState()!==s.LifecycleState.PERSISTED){n.setResponse(e);o=true}return n}const r="Error updating runtime persistence: storage returned unknown flex objects";a.error(r);throw new Error(r)})});if(c!==x[e].runtimePersistence.flexObjects.length){o=true}return o}function E(e){var t=e.reference;var n=false;if(!x[t].componentData){var a=i.getComponentById(e.componentId);x[t].componentData=a?a.getComponentData():e.componentData;n=true}if(!x[t].storageResponse){x[t].storageResponse=z(t,x[t].unfilteredStorageResponse);delete x[t].runtimePersistence;n=true}if(!r.get(["flexObjects",t,e.componentId],y)){r.set(["flexObjects",t,e.componentId],[],y)}if(!x[t].runtimePersistence){x[t].runtimePersistence=k(x[t],y.flexObjects[t][e.componentId]||[]);n=true}if(n){C.checkUpdate({reference:t})}}function z(e,a){const i=n({},a);const c=i.changes;if(g.isLayerFilteringRequired(e)){const n=m.getByReference(e);t(j,function(e,t){t.pathInResponse.forEach(function(e){const t=r.get(e,c).filter(function(e){return!e.layer||!g.isOverLayer(e.layer,n.maxLayer)});r.set(e,t,c)})})}return i}function L(e){O[e.reference]=l.loadFlexData(e).then(async t=>{t.authors=await l.loadVariantsAuthors(e.reference);return t}).then(t=>{x[e.reference]=n({},{unfilteredStorageResponse:t,preparedMaps:{},componentId:e.componentId,componentData:e.componentData,partialFlexState:e.partialFlexState});N(e.reference,t);Object.freeze(x[e.reference].storageResponse);Object.freeze(x[e.reference].unfilteredStorageResponse);return t});return O[e.reference]}function N(e,t){var n=t&&t.changes||{};var r=m.getByReference(e);if(n.info!==undefined){r=Object.assign(r,n.info)}m.setByReference(r,e)}function U(e){var t=x[e.reference];if(t.partialFlexState===true&&e.partialFlexState!==true){t.partialFlexState=false;e.partialFlexData=n({},t.unfilteredStorageResponse.changes);e.reInitialize=true}return e}function A(e){var t=x[e.reference].componentId;if(!e.reInitialize&&t!==e.componentId){e.reInitialize=true}return e}function B(){return h("sap/ui/fl/ChangePersistenceFactory").then(function(e){v=e}).catch(function(e){a.error(`Error loading modules: ${e.message}`)})}b.getRuntimeOnlyData=function(e){return x[e]?.runtimePersistence?.runtimeOnlyData||{}};b.initialize=function(e){return Promise.all([B()]).then(function(){I(e);var t=e.reference;if(O[t]){return O[t].then(U.bind(null,e)).then(A).then(function(e){return e.reInitialize?L(e):x[t].unfilteredStorageResponse})}return L(e)}).then(function(e){E(e)}.bind(null,e))};b.isInitialized=function(e){var t=e.reference?e.reference:d.getFlexReferenceForControl(e.control);return!!x[t]};b.clearAndInitialize=function(e){I(e);b.clearState(e.reference);return b.initialize(e)};b.update=function(e){I(e);var t=e.reference;var n=x[t].runtimePersistence;if(v&&(v._instanceCache||{}).hasOwnProperty(t)){v._instanceCache[t].removeDirtyChanges()}return(O[t]||Promise.resolve()).then(L.bind(this,e)).then(function(){x[t].storageResponse=z(t,x[t].unfilteredStorageResponse);var e=w(t,x[t].storageResponse,n);if(e){C.checkUpdate({reference:t})}})};function T(e){switch(e.fileType){case"change":if(e.selector&&e.selector.persistencyKey){return["comp","changes"]}if(e.variantReference){return"variantDependentControlChanges"}return"changes";case"ctrl_variant":return"variants";case"ctrl_variant_change":return"variantChanges";case"ctrl_variant_management_change":return"variantManagementChanges";case"variant":return["comp","variants"];default:return""}}b.updateStorageResponse=function(e,t){const n=[];t.forEach(t=>{if(t.type==="ui2"){x[e].unfilteredStorageResponse.changes.ui2personalization=t.newData}else{const a=T(t.flexObject);const i=t.flexObject.fileName;const c=r.get(a,x[e].unfilteredStorageResponse.changes);const o=r.get(a,x[e].storageResponse.changes);const f=x[e].runtimePersistence.flexObjects.findIndex(e=>e.getId()===i);const u=x[e].runtimePersistence.flexObjects[f];switch(t.type){case"add":c.push(t.flexObject);o.push(t.flexObject);if(f<0){throw new Error("Flex response includes unknown flex object")}break;case"delete":o.splice(o.findIndex(e=>e.fileName===i),1);c.splice(c.findIndex(e=>e.fileName===i),1);if(f>=0){x[e].runtimePersistence.flexObjects.splice(f,1);n.push({type:"removeFlexObject",updatedObject:u})}break;case"update":o.splice(o.findIndex(e=>e.fileName===i),1,t.flexObject);c.splice(c.findIndex(e=>e.fileName===i),1,t.flexObject);if(u&&u.getState()!==s.LifecycleState.PERSISTED){u.setResponse(t.flexObject);n.push({type:"updateFlexObject",updatedObject:u})}break;default:}}});if(n.length>0){C.checkUpdate({reference:e},n)}};b.clearState=function(e){if(e){delete x[e];delete O[e];C.clearCachedResult({reference:e});if(v&&(v._instanceCache||{}).hasOwnProperty(e)){v._instanceCache[e].removeDirtyChanges()}}else{x={};O={};C.clearCachedResult()}};b.setInitialNonFlCompVariantData=function(e,t,n,r,a){y.compVariants[e]||={};y.compVariants[e][t]={};y.compVariants[e][t].standardVariant=n;y.compVariants[e][t].variants=r;y.compVariants[e][t].controlId=a};b.getInitialNonFlCompVariantData=function(e){return y.compVariants[e]};b.resetInitialNonFlCompVariantData=function(e){delete y.compVariants[e]};b.addRuntimeSteadyObject=function(e,t,n){y.flexObjects[e]||={};y.flexObjects[e][t]||=[];y.flexObjects[e][t].push(n);C.checkUpdate({reference:e},[{type:"addFlexObject",updatedObject:n}])};b.clearRuntimeSteadyObjects=function(e,t){if(y.flexObjects[e]){delete y.flexObjects[e][t];C.clearCachedResult({reference:e})}};b.rebuildFilteredResponse=function(e){if(x[e]){x[e].preparedMaps={};x[e].storageResponse=z(e,x[e].unfilteredStorageResponse);x[e].runtimePersistence=k(x[e],y.flexObjects[e][x[e].componentId]||[]);C.checkUpdate({reference:e})}};b.addDirtyFlexObject=function(e,t){const n=m.getByReference(e)?.adaptationLayer;const r=!!n&&g.isOverLayer(t.getLayer(),n);if(!r&&x[e]){x[e].runtimePersistence.flexObjects.push(t);C.checkUpdate({reference:e},[{type:"addFlexObject",updatedObject:t}])}};b.addDirtyFlexObjects=function(e,t){const n=m.getByReference(e)?.adaptationLayer;t=!n?t:t.filter(e=>!g.isOverLayer(e.getLayer(),n));if(t.length>0&&x[e]){x[e].runtimePersistence.flexObjects=x[e].runtimePersistence.flexObjects.concat(t);C.checkUpdate({reference:e},t.map(function(e){return{type:"addFlexObject",updatedObject:e}}))}};b.removeDirtyFlexObject=function(e,t){if(x[e]){const n=x[e].runtimePersistence.flexObjects;const r=n.indexOf(t);if(r>=0){n.splice(r,1);C.checkUpdate({reference:e},[{type:"removeFlexObject",updatedObject:t}])}}};b.removeDirtyFlexObjects=function(e,t){if(x[e]&&t.length>0){let n=false;const r=x[e].runtimePersistence.flexObjects;t.forEach(function(e){const t=r.indexOf(e);if(t>=0){n=true;r.splice(t,1)}});if(n){C.checkUpdate({reference:e},t.map(function(e){return{type:"removeFlexObject",updatedObject:e}}))}}};b.getComponentIdForReference=function(e){return x[e]?.componentId};b.getFlexObjectsDataSelector=function(){return C};b.getAppDescriptorChanges=function(e){return _(e).appDescriptorChanges};b.getUI2Personalization=function(e){return n({},x[e].unfilteredStorageResponse.changes.ui2personalization)};b.getCompVariantsMap=function(e){return M(e)};b.callPrepareFunction=function(e,t){return j[e].prepareFunction(t)};b.getStorageResponse=function(e){if(O[e]){return O[e].then(function(){return x[e].unfilteredStorageResponse})}return Promise.resolve()};b.getComponentData=function(e){return x[e]&&x[e].componentData};return b});
//# sourceMappingURL=FlexState.js.map