/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_isEqual","sap/base/util/each","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/BusyIndicator","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/changes/UIChangesState","sap/ui/fl/apply/_internal/flexState/controlVariants/Switcher","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/fl/registry/Settings","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/ui/model/BindingMode","sap/ui/model/json/JSONModel"],function(e,t,n,a,r,i,o,s,c,l,h,f,u,p,g,d,v,m,C,V,y,R,D,b,S,x,F,I){"use strict";var M={};function P(e,t){return _(function(e,t){var n=t.model;var a=t.vmReference;var r=false;var o=i.get([a,"modified"],n.oData);var s=e.key;var c=e.key;return Promise.resolve().then(function(){if(i.get([a,"currentVariant"],n.oData)&&n.oData[a].currentVariant!==s){c=n.oData[a].currentVariant;r=true;return n.updateCurrentVariant({variantManagementReference:a,newVariantReference:s,appComponent:n.oAppComponent,internallyCalled:true})}}).then(function(){if(o){var e=C.getControlChangesForVariant({reference:n.sFlexReference,vmReference:a,vReference:c});return E({changes:e,vmReference:a,vReference:c,revert:!r,model:n})}return Promise.resolve()}).then(function(){if(!r){n.callVariantSwitchListeners(a,n.oData[a].currentVariant)}})}.bind(null,e.getParameters(),t),t.model)}function E(e){var t=e.model._getDirtyChangesFromVariantChanges(e.changes);t=t.reverse();return Promise.resolve().then(function(){if(e.revert){return u.revertMultipleChanges(t,{appComponent:e.model.oAppComponent,modifier:s,flexController:e.model.oFlexController})}return undefined}).then(function(){e.model.oChangePersistence.deleteChanges(t)})}function _(e,t){t._oVariantSwitchPromise=t._oVariantSwitchPromise.catch(function(){}).then(e);t.oFlexController.setVariantSwitchPromise(t._oVariantSwitchPromise);return t._oVariantSwitchPromise}function U(e,t){M[e]=t}function w(e,t){return m.switchVariant(e).then(function(){if(this.oData[e.vmReference].updateVariantInURL){p.updateVariantInURL({vmReference:e.vmReference,newVReference:e.newVReference,model:this})}this.callVariantSwitchListeners(e.vmReference,e.newVReference,undefined,t)}.bind(this))}function A(e){var t=S.getInstanceOrUndef();if(t&&!t.isVariantPersonalizationEnabled()){e.remove=false;e.rename=false;e.change=false}}function L(e){var t=S.getInstanceOrUndef();var n=t&&(t.isKeyUser()||!t.getUserId()||t.isPublicFlVariantEnabled()&&t.getUserId().toUpperCase()===e.author.toUpperCase());e.remove=n;e.rename=n;e.change=n}function T(e,t,n){var a=n?D.getCurrentLayer():R.USER;if(e.layer===a&&e.key!==t){return true}return false}function O(e){return new Promise(function(t){if(e.getDomRef()){t()}else{e.addEventDelegate({onAfterRendering(){t()}})}})}function k(){var e=b.getUshellContainer();if(e){var t=[b.getUShellService("UserInfo"),b.getUShellService("URLParsing"),b.getUShellService("Navigation"),b.getUShellService("ShellNavigation")];return Promise.all(t).then(function(e){U("UserInfo",e[0]);U("URLParsing",e[1]);U("Navigation",e[2]);U("ShellNavigation",e[3])}).catch(function(e){throw new Error(`Error getting service from Unified Shell: ${e}`)})}return undefined}function B(e,t){return r({},e.find(function(e){return e.key===t}))}function N(e,t,n){var a={layer:e,control:t,reference:n};var r=x.hasAdaptationsModel(a);return r&&x.getDisplayedAdaptationId(a)}var j=I.extend("sap.ui.fl.variants.VariantModel",{constructor:function(e,t){this.pSequentialImportCompleted=Promise.resolve();I.apply(this,[e]);this.sharing={PRIVATE:"private",PUBLIC:"public"};this.oFlexController=t.flexController;this.oChangePersistence=this.oFlexController._oChangePersistence;this.sFlexReference=V.getFlexReferenceForControl(t.appComponent);this.oAppComponent=t.appComponent;this._oResourceBundle=h.getResourceBundleFor("sap.ui.fl");this._oVariantSwitchPromise=Promise.resolve();this._oVariantAppliedListeners={};this.fnUpdateListener=this.updateData.bind(this);this.oDataSelector=C.getVariantManagementMap();this.oDataSelector.addUpdateListener(this.fnUpdateListener);this.updateData();const n=v.getLiveDependencyMap(this.sFlexReference);C.getInitialChanges({reference:this.sFlexReference},this.oAppComponent.getId(),this.sFlexReference).forEach(e=>{d.addChangeAndUpdateDependencies(e,this.oAppComponent.getId(),n)});this.setDefaultBindingMode(F.OneWay)}});j.prototype.updateData=function(){var e=this.oDataSelector.get({reference:this.sFlexReference});var t=Object.assign({},this.getData());Object.entries(e).forEach(function(e){var n=e[0];var a=Object.assign({},e[1]);t[n]||={};t[n].variants=a.variants.map(function(e){var a=(t[n].variants||[]).find(function(t){return t.key===e.key});return Object.assign({},a||{},e)});t[n].currentVariant=a.currentVariant;t[n].defaultVariant=a.defaultVariant;t[n].modified=a.modified});this.setData(t);this.refresh(true)};j.prototype.invalidateMap=function(){this.oDataSelector.checkUpdate({reference:this.sFlexReference})};j.prototype.initialize=function(){return Promise.all([S.getInstance(),k()]).then(function(){p.initialize({model:this})}.bind(this))};j.prototype.updateCurrentVariant=function(e){var t={vmReference:e.variantManagementReference,currentVReference:this.getCurrentVariantReference(e.variantManagementReference),newVReference:e.newVariantReference,flexController:this.oFlexController,appComponent:e.appComponent||this.oAppComponent,modifier:s,reference:this.sFlexReference};if(e.internallyCalled){return w.call(this,t,e.scenario)}return _(w.bind(this,t,e.scenario),this)};j.prototype.getCurrentVariantReference=function(e){return this.oData[e].currentVariant};j.prototype.getVariantManagementReference=function(e){var t="";var n=-1;Object.keys(this.oData).some(function(a){return this.oData[a].variants.some(function(r,i){if(r.key===e){t=a;n=i;return true}})}.bind(this));return{variantManagementReference:t,variantIndex:n}};j.prototype.getVariant=function(e,t){var n=t||this.getVariantManagementReference(e).variantManagementReference;return B(this.oData[n].variants,e)};j.prototype.getVariantTitle=function(e,t){return B(this.oData[t].variants,e).title};function H(e,t){var n=C.getVariantChangesForVariant({vmReference:e,reference:this.sFlexReference});var a=this.oData[e].defaultVariant;if(t.getExecuteOnSelectionForStandardDefault()&&a===e&&!n.setExecuteOnSelect){var r=B(this.oData[e].variants,e);r.instance.setExecuteOnSelection(true);this.oData[e].variants[0].executeOnSelect=true;return true}return false}j.prototype.attachVariantApplied=function(e){var t=l.getElementById(e.vmControlId);var n=this.getVariantManagementReferenceForControl(t);return this.waitForVMControlInit(n).then(function(e,n){this._oVariantAppliedListeners[e]||={};var a=H.call(this,e,t);if(n.callAfterInitialVariant||a){var r={appComponent:this.oAppComponent,reference:this.sFlexReference,vmReference:e,flexController:this.oFlexController};C.waitForInitialVariantChanges(r).then(function(){var t=this.oData[e].currentVariant;this.callVariantSwitchListeners(e,t,n.callback)}.bind(this))}return O(n.control).then(function(){if(y.getRelevantVariantManagementControlId(n.control,this.getVariantManagementControlIds())===n.vmControlId){this.oData[e].showExecuteOnSelection=true;this.checkUpdate(true);this._oVariantAppliedListeners[e][n.control.getId()]=n.callback}else{o.error("Error in attachVariantApplied: The passed VariantManagement ID does not match the "+"responsible VariantManagement control")}}.bind(this))}.bind(this,n,e))};j.prototype.callVariantSwitchListeners=function(e,t,a,r){if(this._oVariantAppliedListeners[e]){var i=B(this.oData[e].variants,t);if(r){i.createScenario=r}if(a){a(i)}else{n(this._oVariantAppliedListeners[e],function(e,t){t(i)})}}};j.prototype.detachVariantApplied=function(e,t){var n=this.getVariantManagementReferenceForControl(l.getElementById(e));if(this._oVariantAppliedListeners[n]){delete this._oVariantAppliedListeners[n][t]}};j.prototype.eraseDirtyChangesOnVariant=function(e,t){var n=C.getControlChangesForVariant({reference:this.sFlexReference,vmReference:e,vReference:t});var a=this._getDirtyChangesFromVariantChanges(n);return E({changes:n,vmReference:e,vReference:t,model:this,revert:true}).then(function(){return a})};j.prototype.addAndApplyChangesOnVariant=function(e){this.oChangePersistence.addChanges(e,this.oAppComponent);return e.reduce(function(e,t){return e.then(function(){var e=l.getElementById(s.getControlIdBySelector(t.getSelector(),this.oAppComponent));return f.applyChangeOnControl(t,e,{modifier:s,appComponent:this.oAppComponent,view:b.getViewForControl(e)}).then(e=>{if(!e.success){var n=e.error||new Error("The change could not be applied.");this._oChangePersistence.deleteChange(t,true);throw n}})}.bind(this))}.bind(this),Promise.resolve())};j.prototype._getVariantTitleCount=function(e,t){var n=this.getData();return n[t].variants.reduce(function(t,n){if(e.toLowerCase()===n.title.toLowerCase()&&n.visible){t++}return t},0)};function z(e,t){var n={id:t.newVariantReference,variantName:t.title,contexts:t.contexts,layer:t.layer,adaptationId:t.adaptationId,reference:e.getFlexObjectMetadata().reference,generator:t.generator,variantManagementReference:t.variantManagementReference};if(t.layer===R.VENDOR){n.user="SAP"}if(t.currentVariantComparison===1){if(t.sourceVariantSource.instance.getLayer()===t.layer){n.variantReference=t.sourceVariantSource.instance.getVariantReference()}else{n.variantReference=e.getVariantReference()}}else if(t.currentVariantComparison===0){n.variantReference=e.getVariantReference()}else if(t.currentVariantComparison===-1){n.variantReference=t.sourceVariantReference}return g.createFlVariant(n)}j.prototype._duplicateVariant=function(e){var t=e.sourceVariantReference;var n=e.variantManagementReference;var a=this.getVariant(t);var i=C.getControlChangesForVariant({vmReference:n,vReference:t,reference:this.sFlexReference}).map(function(e){return e.convertToFileContent()});e.currentVariantComparison=D.compareAgainstCurrentLayer(a.instance.getLayer(),e.layer);if(e.currentVariantComparison===1){e.sourceVariantSource=this.getVariant(a.instance.getVariantReference())}var o={instance:z(a.instance,e),controlChanges:i,variantChanges:{}};i=o.controlChanges.slice();var s={};o.controlChanges=i.reduce(function(t,n){if(D.compareAgainstCurrentLayer(n.layer,e.layer)>=0){s=r({},n);s.layer=e.layer;s.variantReference=o.instance.getId();s.support||={};s.support.sourceChangeFileName=n.fileName;s.packageName="$TMP";s.fileName=b.createDefaultFileName(s.changeType);t.push(g.createFromFileContent(s))}return t},[]);return o};j.prototype.copyVariant=function(e){var t=this._duplicateVariant(e);t.generator=e.generator;this.oData[e.variantManagementReference].variants.push({key:t.instance.getId(),rename:true,change:true,remove:true,sharing:e.layer===R.USER?this.sharing.PRIVATE:this.sharing.PUBLIC});var n=[];if(e.layer===R.PUBLIC){t.instance.setFavorite(false);var a={selector:s.getSelector(e.newVariantReference,e.appComponent),changeType:"setFavorite",fileType:"ctrl_variant_change",generator:e.generator,layer:R.USER,reference:this.sFlexReference,content:{favorite:true}};n.push(g.createUIChange(a))}n=this.oChangePersistence.addDirtyChanges(n.concat([t.instance].concat(t.controlChanges).concat(e.additionalVariantChanges)));return this.updateCurrentVariant({variantManagementReference:e.variantManagementReference,newVariantReference:t.instance.getId(),appComponent:e.appComponent,internallyCalled:true,scenario:"saveAs"}).then(function(){return n})};j.prototype.removeVariant=function(e){var t=this.oChangePersistence.getDirtyChanges().filter(function(t){return t.getVariantReference&&t.getVariantReference()===e.variant.getId()||t.getId()===e.variant.getId()});return this.updateCurrentVariant({variantManagementReference:e.variantManagementReference,newVariantReference:e.sourceVariantReference,appComponent:e.component}).then(function(){this.oChangePersistence.deleteChanges(t)}.bind(this))};j.prototype._collectModelChanges=function(e,t,n){const a=this.getData()[e];const r=a.variants;const i=[];const o=S.getInstanceOrUndef();const s=e=>r.find(t=>t.key===e);const c=(e,n,a)=>{const r=["setTitle","setExecuteOnSelect","setVisible"].includes(n);const s=r&&o?.isPublicFlVariantEnabled()&&e.layer===R.PUBLIC?R.PUBLIC:t;i.push({variantReference:e.key,changeType:n,layer:s,...a})};n.getParameter("renamed")?.forEach(({key:e,name:t})=>{const n=s(e);c(n,"setTitle",{title:t,originalTitle:n.title})});n.getParameter("fav")?.forEach(({key:e,visible:t})=>{const n=s(e);c(n,"setFavorite",{favorite:t,originalFavorite:n.favorite})});n.getParameter("exe")?.forEach(({key:e,exe:t})=>{const n=s(e);c(n,"setExecuteOnSelect",{executeOnSelect:t,originalExecuteOnSelect:n.executeOnSelect})});n.getParameter("deleted")?.forEach(e=>{const t=s(e);c(t,"setVisible",{visible:false})});n.getParameter("contexts")?.forEach(({key:e,contexts:t})=>{const n=s(e);c(n,"setContexts",{contexts:t,originalContexts:n.contexts})});const l=n.getParameter("def");if(l){i.push({variantManagementReference:e,changeType:"setDefault",defaultVariant:l,originalDefaultVariant:a.defaultVariant,layer:t})}return i};j.prototype.manageVariants=function(e,t,n,a,r){return new Promise(function(i){e.attachEventOnce("manage",{resolve:i,variantManagementReference:t,layer:n},this.fnManageClickRta,this);e.openManagementDialog(true,a,r)}.bind(this))};j.prototype.createVariantChange=function(e,t){var n=this.setVariantProperties(e,t);var a={changeType:t.changeType,layer:t.layer,generator:t.generator,reference:this.sFlexReference};if(t.adaptationId!==undefined){a.adaptationId=t.adaptationId}else{a.adaptationId=N(t.layer,t.appComponent,this.sFlexReference)}if(t.changeType==="setDefault"){a.fileType="ctrl_variant_management_change";a.selector=s.getSelector(e,t.appComponent)}else{a.fileType="ctrl_variant_change";a.selector=s.getSelector(t.variantReference,t.appComponent)}var r=g.createUIChange(a);r.setContent(n);if(t.changeType==="setTitle"){r.setText("title",t.title,"XFLD")}return r};j.prototype.addVariantChange=function(e,t){var n=this.createVariantChange(e,t);this.oChangePersistence.addDirtyChange(n);return n};j.prototype.addVariantChanges=function(e,t){var n=t.map(function(t){return this.createVariantChange(e,t)}.bind(this));this.oChangePersistence.addDirtyChanges(n);return n};j.prototype.deleteVariantChange=function(e,t,n){this.setVariantProperties(e,t);this.oChangePersistence.deleteChange(n)};j.prototype.setVariantProperties=function(e,t){var n=this.getData();var a=this.getVariant(t.variantReference,e).instance;var r={};switch(t.changeType){case"setTitle":a.setName(t.title,true);break;case"setFavorite":r.favorite=t.favorite;a.setFavorite(t.favorite);break;case"setExecuteOnSelect":r.executeOnSelect=t.executeOnSelect;a.setExecuteOnSelection(t.executeOnSelect);break;case"setVisible":r.visible=t.visible;r.createdByReset=false;a.setVisible(t.visible);break;case"setContexts":r.contexts=t.contexts;a.setContexts(t.contexts);break;case"setDefault":r.defaultVariant=t.defaultVariant;var i=p.getStoredHashParams({model:this});if(i){if(n[e].defaultVariant!==n[e].currentVariant&&i.indexOf(n[e].currentVariant)===-1){p.update({parameters:i.concat(n[e].currentVariant),updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this})}else if(n[e].defaultVariant===n[e].currentVariant&&i.indexOf(n[e].currentVariant)>-1){i.splice(i.indexOf(n[e].currentVariant),1);p.update({parameters:i,updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this})}}break;default:break}return r};j.prototype._ensureStandardVariantExists=function(t){var n=this.getData();var r=n[t]||{};var i=e(r,["initPromise"]);if(!n[t]||a(i)){var o=g.createFlVariant({id:t,variantManagementReference:t,variantName:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),user:y.DEFAULT_AUTHOR,layer:R.BASE,reference:this.sFlexReference});C.addRuntimeSteadyObject(this.sFlexReference,this.oAppComponent.getId(),o)}};j.prototype.setModelPropertiesForControl=function(e,t,n){this.oData[e].showFavorites=true;var a=this._bDesignTimeMode;if(a!==t){this._bDesignTimeMode=t;if(t){p.clearAllVariantURLParameters({model:this})}else if(a){p.update({parameters:p.getStoredHashParams({model:this}),updateURL:true,updateHashEntry:false,model:this})}}if(!(typeof this.fnManageClick==="function"&&typeof this.fnManageClickRta==="function")){this._initializeManageVariantsEvents()}n.detachManage(this.fnManageClick,this);if(t&&this.oData[e]._isEditable){this.oData[e].variantsEditable=false;this.oData[e].variants.forEach(function(n){n.rename=true;n.change=true;n.sharing=this.sharing.PUBLIC;n.remove=T(n,e,t)}.bind(this))}else if(this.oData[e]._isEditable){n.attachManage({variantManagementReference:e},this.fnManageClick,this);this.oData[e].variantsEditable=true;this.oData[e].variants.forEach(function(n){n.remove=T(n,e,t);switch(n.layer){case R.USER:n.rename=true;n.change=true;n.sharing=this.sharing.PRIVATE;A(n);break;case R.PUBLIC:n.sharing=this.sharing.PUBLIC;L(n);break;default:n.rename=false;n.change=false;n.sharing=this.sharing.PUBLIC}}.bind(this))}else{this.oData[e].variantsEditable=false;this.oData[e].variants.forEach(function(e){e.remove=false;e.rename=false;e.change=false})}};j.prototype._initializeManageVariantsEvents=function(){this.fnManageClickRta=function(e,t){var n=this._collectModelChanges(t.variantManagementReference,t.layer,e);t.resolve(n)};this.fnManageClick=function(e,t){(async()=>{if(!this.oFlexController||!this.getData()){return}var n=this._collectModelChanges(t.variantManagementReference,R.USER,e);if(n.some(e=>e.visible===false&&e.variantReference===this.getCurrentVariantReference(t.variantManagementReference))){await this.updateCurrentVariant({variantManagementReference:t.variantManagementReference,newVariantReference:t.variantManagementReference})}var a=[];n.forEach(function(e){e.appComponent=this.oAppComponent}.bind(this));a=a.concat(this.addVariantChanges(t.variantManagementReference,n));this.oChangePersistence.saveDirtyChanges(this.oAppComponent,false,a)})()}};function q(e,t,n,a){if(!this._bDesignTimeMode){return e.saveSequenceOfDirtyChanges(t,a).then(function(e){this.invalidateMap();if(e){var t=e.response[0];this.oData[n].variants.forEach(function(e){if(e.key===t.fileName){e.author=t.support.user}})}}.bind(this))}return Promise.resolve()}j.prototype._handleSaveEvent=function(e){if(!this._bDesignTimeMode){var t=e.getSource();var n=e.getParameters();return this._handleSave(t,n)}return Promise.resolve()};j.prototype._handleSave=function(e,t){var n=b.getAppComponentForControl(e);var a=this.getLocalId(e.getId(),n);var i;return _(function(e,t,n){var a=this.getCurrentVariantReference(e);var o=C.getControlChangesForVariant({reference:this.sFlexReference,vmReference:e,vReference:a});if(n.overwrite){return this.oFlexController.saveSequenceOfDirtyChanges(this._getDirtyChangesFromVariantChanges(o),t).then(function(e){this.invalidateMap();return e}.bind(this))}var c=n.layer||(n.public?R.PUBLIC:R.USER);var l=n.layer||R.USER;var h=n.newVariantReference||b.createDefaultFileName("flVariant");var f={variantManagementReference:e,appComponent:t,layer:c,title:n.name,contexts:n.contexts,sourceVariantReference:a,newVariantReference:h,generator:n.generator,additionalVariantChanges:[],adaptationId:N(l,t,this.sFlexReference)};var u={content:{},reference:this.sFlexReference,generator:f.generator,layer:l,adaptationId:f.adaptationId};if(n.def){var p=r({changeType:"setDefault",content:{defaultVariant:h},fileType:"ctrl_variant_management_change",selector:s.getSelector(e,f.appComponent)},u);f.additionalVariantChanges.push(g.createUIChange(p))}if(n.execute){var d=r({changeType:"setExecuteOnSelect",content:{executeOnSelect:true},fileType:"ctrl_variant_change",selector:s.getSelector(f.newVariantReference,f.appComponent)},u);f.additionalVariantChanges.push(g.createUIChange(d))}return this.copyVariant(f).then(function(n){i=n;return E({changes:o,vmReference:e,vReference:a,model:this}).then(q.bind(this,this.oFlexController,i,e,t))}.bind(this))}.bind(this,a,n,t),this).then(function(){return i})};j.prototype.getLocalId=function(e,t){return s.getSelector(e,t).id};j.prototype.getVariantManagementReferenceForControl=function(e){var t=e.getId();var n=b.getAppComponentForControl(e);return n&&n.getLocalId(t)||t};j.prototype.switchToDefaultForVariantManagement=function(e){if(this.oData[e].currentVariant!==this.oData[e].defaultVariant){c.show(200);this.updateCurrentVariant({variantManagementReference:e,newVariantReference:this.oData[e].defaultVariant}).then(function(){c.hide()})}};j.prototype.switchToDefaultForVariant=function(e){Object.keys(this.oData).forEach(function(t){if(!e||this.oData[t].currentVariant===e){this.switchToDefaultForVariantManagement(t)}}.bind(this))};function J(e,t){this.oData[t].variants.forEach(function(n){var a=n.title&&n.title.match(/{(\w+)>(\w.+)}/);if(a){var r=a[1];var i=a[2];var o=e.getModel(r);if(o){var s=o.getResourceBundle().getText(i);var c={variantReference:n.key,changeType:"setTitle",title:s,layer:n.layer,appComponent:this.oAppComponent};var l=this.createVariantChange(t,c);C.addRuntimeSteadyObject(this.sFlexReference,this.oAppComponent.getId(),l)}else{e.attachEventOnce("modelContextChange",J.bind(this,e,t))}}}.bind(this))}j.prototype.registerToModel=function(e){var t=this.getVariantManagementReferenceForControl(e);this._ensureStandardVariantExists(t);this.oData[t]._isEditable=e.getEditable();this.oData[t].showExecuteOnSelection=false;J.call(this,e,t);e.attachEvent("select",{vmReference:t,model:this},P);e.attachSave(this._handleSaveEvent,this);this.setModelPropertiesForControl(t,false,e);var n=e.getUpdateVariantInURL();this.oData[t].updateVariantInURL=n;p.registerControl({vmReference:t,updateURL:!!n,model:this});p.handleModelContextChange({model:this,vmControl:e});if(this.oData[t].initPromise){this.oData[t].initPromise.resolveFunction();delete this.oData[t].initPromise}this.oData[t].init=true;var a={appComponent:this.oAppComponent,reference:this.sFlexReference,vmReference:t,flexController:this.oFlexController};this._oVariantSwitchPromise=this._oVariantSwitchPromise.then(C.waitForInitialVariantChanges.bind(undefined,a))};j.prototype.waitForVMControlInit=function(e){if(!this.oData[e]){this.oData[e]={}}else if(this.oData[e].init){return Promise.resolve()}this.oData[e].initPromise={};this.oData[e].initPromise.promise=new Promise(function(t){this.oData[e].initPromise.resolveFunction=t}.bind(this));return this.oData[e].initPromise.promise};j.prototype._getDirtyChangesFromVariantChanges=function(e){var t=e.map(function(e){return e.getId()});return this.oChangePersistence.getDirtyChanges().filter(function(e){return t.includes(e.getId())&&!e.getSavedToVariant()})};j.prototype.getCurrentControlVariantIds=function(){return Object.keys(this.oData||{}).reduce(function(e,t){return e.concat([this.oData[t].currentVariant])}.bind(this),[])};j.prototype.getVariantManagementControlIds=function(){var e;return Object.keys(this.oData||{}).reduce(function(t,n){if(this.oAppComponent.byId(n)){e=this.oAppComponent.createId(n)}else{e=n}t.push(e);return t}.bind(this),[])};j.prototype.destroy=function(){this.oDataSelector.removeUpdateListener(this.fnUpdateListener);C.clearRuntimeSteadyObjects(this.sFlexReference,this.oAppComponent.getId());C.resetCurrentVariantReference(this.sFlexReference);I.prototype.destroy.apply(this)};j.prototype.getUShellService=function(e){return b.getUshellContainer()&&M[e]};return j});
//# sourceMappingURL=VariantModel.js.map