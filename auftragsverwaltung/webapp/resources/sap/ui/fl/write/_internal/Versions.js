/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/initial/api/Version","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/Storage","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode"],function(e,r,t,n,i,s,a){"use strict";var o={};var d=9;var l=d+1;function f(e){var t=v(e);t.setDefaultBindingMode(a.OneWay);t.setSizeLimit(d);t.setDirtyChanges=function(e){t.setProperty("/dirtyChanges",e);t.updateDraftVersion();t.updateBindings(true)};t.updateDraftVersion=function(){var e=t.getProperty("/versions");var n=t.getProperty("/versioningEnabled");var i=t.getProperty("/dirtyChanges");var s=t.getProperty("/backendDraft");var a=n&&(i||s);t.setProperty("/draftAvailable",a);if(i){t.setProperty("/displayedVersion",r.Number.Draft)}if(!p(e)&&a){e.splice(0,0,{version:r.Number.Draft,type:r.Type.Draft,filenames:[],isPublished:false})}if(p(e)&&!a){e.shift();t.setProperty("/displayedVersion",t.getProperty("/persistedVersion"))}var o=t.getProperty("/displayedVersion")!==t.getProperty("/activeVersion");t.setProperty("/activateEnabled",o)};return t}function v(e){var n;var i=false;var a=r.Number.Original;var o=e.versions;var d=e.versionsModel;var l=p(o);var f=[];if(o.length>0){n=o[0].version}else{n=r.Number.Original}o.forEach(function(e){if(e.version===r.Number.Draft){e.type=r.Type.Draft;e.isPublished=false;f=e.filenames}else{if(a===r.Number.Original){e.type=r.Type.Active;a=e.version}else{e.type=r.Type.Inactive}if(e.version===n&&e.isPublished===false){i=true}}});if(d){d.setProperty("/publishVersionEnabled",i);d.setProperty("/versioningEnabled",e.versioningEnabled);d.setProperty("/versions",o);d.setProperty("/backendDraft",l);d.setProperty("/dirtyChanges",false);d.setProperty("/draftAvailable",l);d.setProperty("/activateEnabled",l);d.setProperty("/activeVersion",a);d.setProperty("/persistedVersion",n);d.setProperty("/displayedVersion",n);d.setProperty("/draftFilenames",f);d.updateBindings(true)}else{var v=t.getByReference(e.reference);return new s({publishVersionEnabled:i,versioningEnabled:e.versioningEnabled,versions:o,backendDraft:l,dirtyChanges:false,draftAvailable:l,activateEnabled:l,activeVersion:a,persistedVersion:v.version||n,displayedVersion:v.version||n,draftFilenames:f})}return d}function u(e,r){var t=[];var n=r.changePersistences;n.forEach(function(e){t=e.getDirtyChanges().concat();e.deleteChanges(t,true)});return t.length>0}function c(r){var t={dirtyChangesExist:false,changePersistences:[]};if(r.reference){var n=e.getChangePersistenceForComponent(r.reference);if(n.getDirtyChanges().length>0){t.dirtyChangesExist=true;t.changePersistences.push(n)}}if(r.nonNormalizedReference){var i=e.getChangePersistenceForComponent(r.nonNormalizedReference);if(i.getDirtyChanges().length>0){t.dirtyChangesExist=true;t.changePersistences.push(i)}}return t}function p(e){return e.some(function(e){return e.version===r.Number.Draft})}function y(e,r){e.setProperty("/backendDraft",false);e.setProperty("/dirtyChanges",false);e.setProperty("/draftAvailable",false);e.setProperty("/activateEnabled",false);e.setProperty("/displayedVersion",r);e.setProperty("/persistedVersion",r);e.updateBindings(true)}var g={};g.initialize=function(e){var r=e.reference;var t=e.layer;e.limit=l;return n.getInstance().then(function(n){var s=n.isVersioningEnabled(t);if(o&&o[r]&&o[r][t]){return o[r][t]}var a=s?i.versions.load(e):Promise.resolve([]);return a.then(function(r){e.versioningEnabled=s;e.versions=r;return f(e)}).then(function(e){o[r]||={};o[r][t]||={};o[r][t]=e;return o[r][t]})})};g.getVersionsModel=function(e){var r=e.reference;var t=e.layer;if(!g.hasVersionsModel(e)){throw Error(`Versions Model for reference '${r}' and layer '${t}' were not initialized.`)}var n=c(e);if(n.dirtyChangesExist){o[r][t].updateDraftVersion(e)}return o[r][t]};g.hasVersionsModel=function(e){var r=e.reference;var t=e.layer;return!!(o[r]&&o[r][t])};g.clearInstances=function(){o={}};g.updateModelFromBackend=function(e){if(g.hasVersionsModel(e)&&g.getVersionsModel(e).getProperty("/versioningEnabled")){e.limit=l;return i.versions.load(e).then(function(r){var t=g.getVersionsModel(e);e.versioningEnabled=t.getProperty("/versioningEnabled");e.versions=r;e.versionsModel=t;return v(e)})}return undefined};g.onAllChangesSaved=function(e){var t=g.getVersionsModel(e);var n=t.getProperty("/versioningEnabled");var i=t.getProperty("/dirtyChanges");var s=t.getProperty("/draftFilenames");t.setProperty("/draftFilenames",s.concat(e.draftFilenames));t.setProperty("/dirtyChanges",true);t.setProperty("/backendDraft",n&&i||!!e.contextBasedAdaptation);t.updateDraftVersion();t.setProperty("/persistedVersion",r.Number.Draft);t.updateBindings(true)};g.activate=function(e){var t=g.getVersionsModel(e);var n=t.getProperty("/versions");var s=p(n);var a=t.getProperty("/activeVersion");if(e.displayedVersion===a){return Promise.reject("Version is already active")}e.version=e.displayedVersion;var o=c(e);var d=o.changePersistences;var l=d.some(function(e){return e.getDirtyChanges().length>0});if(l){return Promise.reject("unsaved changes exists")}return i.versions.activate(e).then(function(e){n.forEach(function(e){e.type=r.Type.Inactive});e.type=r.Type.Active;e.isPublished=false;if(s){n.shift()}n.splice(0,0,e);t.setProperty("/activeVersion",e.version);t.setProperty("/publishVersionEnabled",true);t.setProperty("/draftFilenames",[]);y(t,e.version)})};g.discardDraft=function(e){var r=g.getVersionsModel(e);var t=c(e);var n=r.getProperty("/backendDraft");var s=n?i.versions.discardDraft(e):Promise.resolve();return s.then(function(){var i=r.getProperty("/versions");i.shift();y(r,r.getProperty("/activeVersion"));var s=u(e,t);return{backendChangesDiscarded:n,dirtyChangesDiscarded:s}})};g.publish=function(e){var r=g.getVersionsModel({reference:e.reference,layer:e.layer});return i.versions.publish(e).then(function(t){if(t!=="Error"&&t!=="Cancel"){r.setProperty("/publishVersionEnabled",false);var n=r.getProperty("/versions");var i=false;n.forEach(function(r){if(r.isPublished){return}if(r.version===e.version){i=true}if(i&&!r.isPublished){r.isPublished=true}})}return t})};return g});
//# sourceMappingURL=Versions.js.map