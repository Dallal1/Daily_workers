/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_union","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/changes/UIChangesState","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/initial/api/Version","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/_internal/Storage","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,t,n,r,a,i,o,s,c,p,l,f,u,h,g,d,C,y,m,v){"use strict";const D=new f({id:"variantIndependentUIChanges",parentDataSelector:u.getFlexObjectsDataSelector(),executeFunction(e){return e.filter(function(e){const t=e.isA("sap.ui.fl.apply._internal.flexObjects.UIChange");const n=e.isA("sap.ui.fl.apply._internal.flexObjects.ControllerExtensionChange");const r=e.getFileType()==="change"||e.getFileType()==="codeExt";return(t||n)&&r&&!e.getVariantReference()&&!e.getSelector().persistencyKey})}});var _=function(e){this._mComponent=e;if(!this._mComponent||!this._mComponent.name){t.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.")}this._aDirtyChanges=[];this._oMessagebundle=undefined;D.clearCachedResult({reference:this._mComponent.name})};async function S(e,n,r){try{if(r){await u.update(n)}await u.getStorageResponse(e)}catch(e){t.warning("Problem during ChangePersistence.prototype.getChangesForComponent")}}_.prototype.getChangesForComponent=async function(e,t){e||={};await S(this._mComponent.name,e,t);const n=u.getFlexObjectsDataSelector().get({reference:this._mComponent.name});if(!n.length){return[]}let r=D.get({reference:this._mComponent.name});if(!e.includeCtrlVariants){r=r.concat(l.getInitialChanges({reference:this._mComponent.name}))}else{r=r.concat(l.getVariantDependentFlexObjects(this._mComponent.name))}if(e.currentLayer){r=m.filterChangeOrChangeDefinitionsByCurrentLayer(r,e.currentLayer)}return r};_.prototype.getOpenDependentChangesForControl=function(e,t){return c.getOpenDependentChangesForControl(this.getDependencyMapForComponent(),n.getControlIdBySelector(e,t),t)};_.prototype.addChangeAndUpdateDependencies=function(e,t,n){t.setInitialApplyState();if(n){c.insertChange(t,this.getDependencyMapForComponent(),n)}c.addChangeAndUpdateDependencies(t,e,this.getDependencyMapForComponent())};_.prototype._addRunTimeCreatedChangeToDependencyMap=function(e,t){c.addRuntimeChangeToMap(t,e,this.getDependencyMapForComponent())};_.prototype.getDependencyMapForComponent=function(){return p.getLiveDependencyMap(this._mComponent.name)};_.prototype.getAllUIChanges=function(t){var n=e(this.getDependencyMapForComponent().aChanges,t.includeDirtyChanges&&this.getDirtyChanges()).filter(function(e){return Boolean(e)&&e.getFileType()==="change"&&m.compareAgainstCurrentLayer(e.getLayer(),t.layer)===0});return n};_.prototype.getChangesForView=function(e){return this.getChangesForComponent(e).then(function(t){return t.filter(i.filterChangeByView.bind(undefined,e))})};function b(e,t){this._addRunTimeCreatedChangeToDependencyMap(t,e);this._addPropagationListener(t)}_.prototype.addChange=function(e,t){var n=this.addDirtyChange(e);b.call(this,n,t);return n};_.prototype.addChanges=function(e,t){var n=this.addDirtyChanges(e);n.forEach(function(e){b.call(this,e,t)}.bind(this));return n};_.prototype.addDirtyChange=function(e,t){var n;if(typeof e.isA==="function"&&e.isA("sap.ui.fl.apply._internal.flexObjects.FlexObject")){n=e}else{n=o.createFromFileContent(e)}if(this._aDirtyChanges.indexOf(n)===-1){this._aDirtyChanges.push(n);if(!t){u.addDirtyFlexObject(this._mComponent.name,n)}}return n};_.prototype.addDirtyChanges=function(e){var t=e.map(function(e){return this.addDirtyChange(e,true)}.bind(this));u.addDirtyFlexObjects(this._mComponent.name,t);return t};_.prototype._addPropagationListener=function(e){var t=v.getAppComponentForControl(e);if(t instanceof r){var n=function(e){return!e._bIsSapUiFlFlexControllerApplyChangesOnControl};var i=t.getPropagationListeners().every(n);if(i){var o=a.applyAllChangesForControl.bind(a,t,this._mComponent.name);o._bIsSapUiFlFlexControllerApplyChangesOnControl=true;t.addPropagationListener(o)}}};_.prototype._deleteNotSavedChanges=function(e,t,n){e.filter(function(e){return!t.some(function(t){return e.getId()===t.getId()})}).forEach(function(e){if(n){this.removeChange(e);u.updateStorageResponse(this._mComponent.name,[{flexObject:e.convertToFileContent(),type:"delete"}])}else{this.deleteChange(e)}}.bind(this))};function F(e,t){var n=e.map(function(e){return e[t]()});var r=n.filter(function(e,t,n){return n.indexOf(e)===t});return r.length===1}function x(e,t,n){var r=false;if(!e||t.length<2||!F(t,"getLayer")){return false}if(n){r=true}else{var a=t[0].getLayer();if([y.CUSTOMER,y.USER].includes(a)){r=true}}var i=new URLSearchParams(window.location.search);if(i.has("sap-ui-xx-condense-changes")){r=i.get("sap-ui-xx-condense-changes")==="true"}return r}function O(e){var t=g.getInstanceOrUndef()&&g.getInstanceOrUndef().isCondensingEnabled();if(t&&!F(e,"getNamespace")){t=false}return t}function L(e,t,n,r){this._massUpdateCacheAndDirtyState(t,n);this._deleteNotSavedChanges(e,t,r)}function I(e,t,n,r){if(!e.length&&!n){return[]}var a=this.getDependencyMapForComponent().aChanges.filter(function(e){if(r===y.CUSTOMER&&t){return e.getState()===s.LifecycleState.PERSISTED&&t.includes(e.getId())}return e.getState()===s.LifecycleState.PERSISTED&&m.compareAgainstCurrentLayer(e.getLayer(),r)===0});return a.concat(e)}function E(e){if(e.length){var t=U(e);var n=true;if(g.getInstanceOrUndef()&&g.getInstanceOrUndef().hasPersoConnector()){var r=j(e);n=r.length===1}return t.length===1&&n}return true}function T(e,t,n,r,a,i){var o=[];var c=Promise.resolve();var p=i.filter(function(e){if(e.getState()===s.LifecycleState.DELETED){o.push(e);return false}return true});if(o.length){c=this.saveSequenceOfDirtyChanges(o,r,n)}return c.then(function(){if(p.length){return C.write({layer:e,flexObjects:R(p),transport:t,isLegacyVariant:false,parentVersion:n}).then(function(e){L.call(this,a,p,r);return e}.bind(this))}return this._deleteNotSavedChanges(a,i)}.bind(this))}_.prototype.saveDirtyChanges=function(e,t,n,r,a,i,o){var s=n||this._aDirtyChanges;var c=s.length&&s[0].getLayer()||o;var p=I.call(this,s,a,i,c);var l=O(p)&&x(e,p,i);var f=l?p:s;var u=f.slice(0);var h=U(s);if(E(s)){var g=Promise.resolve(u);if(x(e,u,i)){g=d.condense(e,u)}return g.then(function(e){var n=h[0];if(l){return C.condense({allChanges:f,condensedChanges:e,layer:c,transport:n,isLegacyVariant:false,parentVersion:r}).then(function(n){L.call(this,f,e,t,true);return n}.bind(this))}return T.call(this,c,n,r,t,f,e)}.bind(this))}return this.saveSequenceOfDirtyChanges(s,t,r)};_.prototype.saveSequenceOfDirtyChanges=function(e,t,n){var r;if(n){var a=e.filter(function(e){return e.getState()===s.LifecycleState.NEW});r=[].concat(a).shift()}return e.reduce(function(e,a){return e.then(M.bind(undefined,a,r,n)).then(this._updateCacheAndDirtyState.bind(this,a,t))}.bind(this),Promise.resolve())};function M(e,t,n){switch(e.getState()){case s.LifecycleState.NEW:if(n!==undefined){n=e===t?n:h.Number.Draft}return C.write({layer:e.getLayer(),flexObjects:[e.convertToFileContent()],transport:e.getRequest(),parentVersion:n});case s.LifecycleState.DELETED:return C.remove({flexObject:e.convertToFileContent(),layer:e.getLayer(),transport:e.getRequest(),parentVersion:n});default:return Promise.resolve()}}_.prototype._updateCacheAndDirtyState=function(e,t){this._aDirtyChanges=this._aDirtyChanges.filter(function(t){return e.getId()!==t.getId()});if(!t){switch(e.getState()){case s.LifecycleState.NEW:u.updateStorageResponse(this._mComponent.name,[{type:"add",flexObject:e.convertToFileContent()}]);break;case s.LifecycleState.DELETED:u.updateStorageResponse(this._mComponent.name,[{type:"delete",flexObject:e.convertToFileContent()}]);break;case s.LifecycleState.DIRTY:u.updateStorageResponse(this._mComponent.name,[{type:"update",flexObject:e.convertToFileContent()}]);break;default:}}};_.prototype._massUpdateCacheAndDirtyState=function(e,t){e.forEach(function(e){this._updateCacheAndDirtyState(e,t)},this)};function U(e){var t=[];e.forEach(function(e){var n=e.getRequest();if(t.indexOf(n)===-1){t.push(n)}});return t}function j(e){var t=[];e.forEach(function(e){var n=e.getLayer();if(t.indexOf(n)===-1){t.push(n)}});return t}function R(e){var t=[];e.forEach(function(e){t.push(e.convertToFileContent())});return t}_.prototype.getDirtyChanges=function(){return this._aDirtyChanges};_.prototype.deleteChange=function(e,t,n){var r=this._aDirtyChanges.indexOf(e);if(r>-1){if(e.getState()===s.LifecycleState.DELETED){return}this._aDirtyChanges.splice(r,1);if(!n){u.removeDirtyFlexObject(this._mComponent.name,e)}this._deleteChangeInMap(e,t);return}e.markForDeletion();this.addDirtyChange(e);this._deleteChangeInMap(e,t)};_.prototype.deleteChanges=function(e,t){e.forEach(function(e){this.deleteChange(e,t,true)}.bind(this));u.removeDirtyFlexObjects(this._mComponent.name,e)};_.prototype.removeChange=function(e){var t=this._aDirtyChanges.indexOf(e);if(t>-1){this._aDirtyChanges.splice(t,1);u.removeDirtyFlexObject(this._mComponent.name,e)}this._deleteChangeInMap(e)};_.prototype._deleteChangeInMap=function(e,t){var n=e.getId();c.removeChangeFromMap(this.getDependencyMapForComponent(),n);if(!t){c.removeChangeFromDependencies(this.getDependencyMapForComponent(),n)}};function A(e,t){return(t.getRequest()==="$TMP"||t.getRequest()==="")&&t.getLayer()===e}function w(e,t){return t.getState()===s.LifecycleState.PERSISTED&&t.getLayer()===e}function P(){var e=[];var t=u.getCompVariantsMap(this._mComponent.name);for(var n in t){for(var r in t[n].byId){e.push(t[n].byId[r])}}return e}_.prototype.transportAllUIChanges=function(e,t,n,r){return this.getChangesForComponent({currentLayer:n,includeCtrlVariants:true}).then(function(e){var a=P.call(this);e=e.concat(a.filter(A.bind(this,n)));return C.publish({transportDialogSettings:{styleClass:t},layer:n,reference:this._mComponent.name,localChanges:e,appVariantDescriptors:r})}.bind(this))};_.prototype._getChangesFromMapByNames=function(e){return this.getDependencyMapForComponent().aChanges.filter(function(t){return e.indexOf(t.getId())!==-1})};_.prototype.removeDirtyChanges=function(e,t,r,a,i){var o=[].concat(e||[]);var s=this._aDirtyChanges;var c=s.filter(function(e){var s=true;if(o.length&&!o.includes(e.getLayer())){return false}if(a&&e.getSupportInformation().generator!==a){return false}if(r){var c=e.getSelector();s=r.getId()===n.getControlIdBySelector(c,t)}if(i){s&&=i.indexOf(e.getChangeType())!==-1}return s});u.removeDirtyFlexObjects(this._mComponent.name,c);c.forEach(function(e){var t=s.indexOf(e);s.splice(t,1)});return Promise.resolve(c)};_.prototype.resetChanges=async function(e,t,n,r){const a=n&&n.length>0;const i=r&&r.length>0;const o=g.getInstanceOrUndef()&&g.getInstanceOrUndef().isPublicLayerAvailable();const s=t===undefined&&n===undefined&&r===undefined;const c=o&&s?P.call(this).filter(w.bind(this,e)):[];const p=await this.getChangesForComponent({currentLayer:e,includeCtrlVariants:true});const l=p.concat(c);const f={reference:this._mComponent.name,layer:e,changes:l};if(t){f.generator=t}if(a){f.selectorIds=n}if(i){f.changeTypes=r}const h=await C.reset(f);if(n||r){const e=[];if(h&&h.response&&h.response.length>0){h.response.forEach(function(t){e.push(t.fileName)})}const t=this._getChangesFromMapByNames(e);u.updateStorageResponse(this._mComponent.name,t.map(e=>({flexObject:e.convertToFileContent(),type:"delete"})));return t}return[]};return _});
//# sourceMappingURL=ChangePersistence.js.map