/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/Element","sap/ui/unified/Menu","sap/ui/unified/MenuItem","sap/ui/unified/MenuTextFieldItem","sap/ui/unified/MenuRenderer","./utils/TableUtils","sap/base/assert","sap/ui/thirdparty/jquery"],function(e,t,i,n,o,u,l,r,jQuery){"use strict";var a=new window.WeakMap;var s=i.extend("sap.ui.table.ColumnMenu",{metadata:{library:"sap.ui.table"},renderer:u});s.prototype.init=function(){if(i.prototype.init){i.prototype.init.apply(this,arguments)}this.addStyleClass("sapUiTableColumnMenu");this._bInvalidated=true;this._iPopupClosedTimeoutId=null};s.prototype.exit=function(){if(i.prototype.exit){i.prototype.exit.apply(this,arguments)}window.clearTimeout(this._iPopupClosedTimeoutId);s._destroyColumnVisibilityMenuItem(this._getTable())};s.prototype.onThemeChanged=function(){if(this.getDomRef()){this._invalidate()}};s.prototype.setParent=function(e){this._invalidate();return i.prototype.setParent.apply(this,arguments)};s.prototype._getColumn=function(){var e=this.getParent();return l.isA(e,"sap.ui.table.Column")?e:null};s.prototype._getTable=function(){var e=this._getColumn();return e?e._getTable():null};s._destroyColumnVisibilityMenuItem=function(e){if(!e||!e._oColumnVisibilityMenuItem){return}e._oColumnVisibilityMenuItem.destroy();e._oColumnVisibilityMenuItem=null};s.prototype._removeColumnVisibilityFromAggregation=function(){var e=this._getTable();if(!e||e._oColumnVisibilityMenuItem){return}this.removeAggregation("items",e._oColumnVisibilityMenuItem,true)};s.prototype._invalidate=function(){this._removeColumnVisibilityFromAggregation();this.destroyItems();this._bInvalidated=true};s.prototype.open=function(){if(!this._bInvalidated&&this._getColumn()){this._addColumnVisibilityMenuItem()}if(this._bInvalidated){this._bInvalidated=false;this._addMenuItems()}l.Hook.call(this._getTable(),l.Hook.Keys.Table.OpenMenu,l.getCellInfo(arguments[4]),this);if(this.getItems().length>0){this._lastFocusedDomRef=arguments[4];i.prototype.open.apply(this,arguments)}};s.prototype._addMenuItems=function(){if(this._getColumn()){this._addSortMenuItem(false);this._addSortMenuItem(true);this._addFilterMenuItem();this._addGroupMenuItem();this._addFreezeMenuItem();this._addColumnVisibilityMenuItem()}};s.prototype._addSortMenuItem=function(e){var t=this._getColumn();if(t.isSortableByMenu()){var i=e?"desc":"asc";var n=e?"sort-descending":"sort-ascending";this.addItem(this._createMenuItem(i,"TBL_SORT_"+i.toUpperCase(),n,function(i){t.sort(e,i.getParameter("ctrlKey")===true)}))}};s.prototype._addFilterMenuItem=function(){var e=this._getColumn();if(e.isFilterableByMenu()){var t=e.getParent();var i=t&&t.getEnableCustomFilter();if(i){this.addItem(this._createMenuItem("filter","TBL_FILTER_ITEM","filter",function(){t.fireCustomFilter({column:e})}))}else{this.addItem(this._createMenuTextFieldItem("filter","TBL_FILTER","filter",e.getFilterValue(),function(){e.filter(this.getValue())}))}}};s.prototype._addGroupMenuItem=function(){var e=this._getColumn();if(e.isGroupableByMenu()){var t=this._getTable();this.addItem(this._createMenuItem("group","TBL_GROUP",null,function(){var i;t.setGroupBy(e);if(l.isNoDataVisible(t)){i=t.getDomRef("noDataCnt")}else{i=t.getDomRef("rowsel0")}if(i){i.focus()}}))}};s.prototype._addFreezeMenuItem=function(){var e=this._getColumn();var t=this._getTable();var i=t&&t.getEnableColumnFreeze();if(i){var n=e.getIndex();var o=n+l.Column.getHeaderSpan(e)==t.getComputedFixedColumnCount();this.addItem(this._createMenuItem("freeze",o?"TBL_UNFREEZE":"TBL_FREEZE",null,function(){var i=t.fireColumnFreeze({column:e});if(i){if(o){t.setFixedColumnCount(0)}else{t.setFixedColumnCount(n+1)}}}))}};s.prototype._addColumnVisibilityMenuItem=function(){var e=this._getTable();if(e&&e.getShowColumnVisibilityMenu()){if(!e._oColumnVisibilityMenuItem||e._oColumnVisibilityMenuItem.bIsDestroyed){e._oColumnVisibilityMenuItem=this._createMenuItem("column-visibilty","TBL_COLUMNS");var t=new i(e._oColumnVisibilityMenuItem.getId()+"-menu");e._oColumnVisibilityMenuItem.setSubmenu(t)}this.addItem(e._oColumnVisibilityMenuItem);this._updateColumnVisibilityMenuItem()}};s.prototype._createColumnVisibilityMenuItem=function(e){var t=this._getTable();var i=l.Column.getHeaderText(e);return new n({text:i,icon:e.getVisible()?"sap-icon://accept":null,ariaLabelledBy:[t.getId()+(e.getVisible()?"-ariahidecolmenu":"-ariashowcolmenu")],select:jQuery.proxy(function(i){var n=!e.getVisible();if(n||l.getVisibleColumnCount(t)>1){var o=true;if(l.isA(t,"sap.ui.table.Table")){o=t.fireColumnVisibility({column:e,newVisible:n})}if(o){if(t.getFocusDomRef().getAttribute("id")===e.getId()){var u=t._getVisibleColumns();u[Math.min(u.indexOf(e)+1,l.getVisibleColumnCount(t)-2)].focus()}e.setVisible(n)}}},this)})};s.prototype._createMenuItem=function(e,t,i,o){return new n(this.getId()+"-"+e,{text:l.getResourceText(t),icon:i?"sap-icon://"+i:null,select:o||function(){}})};s.prototype._createMenuTextFieldItem=function(e,t,i,n,u){u=u||function(){};return new o(this.getId()+"-"+e,{label:l.getResourceText(t),icon:i?"sap-icon://"+i:null,value:n,select:u||function(){}})};s.prototype._setFilterValue=function(e){var i=this.getParent();var n=i?i.getParent():undefined;var o=t.getElementById(this.getId()+"-filter");if(o&&o.setValue&&(n&&!n.getEnableCustomFilter())){o.setValue(e)}return this};s.prototype._setFilterState=function(e){var i=this.getParent();var n=i?i.getParent():undefined;var o=t.getElementById(this.getId()+"-filter");if(o&&o.setValueState&&(n&&!n.getEnableCustomFilter())){o.setValueState(e)}return this};function m(e){var t=e.getColumns();if(e.getColumnVisibilityMenuSorter&&typeof e.getColumnVisibilityMenuSorter==="function"){var i=e.getColumnVisibilityMenuSorter();if(typeof i==="function"){t=t.sort(i)}}return t}function d(e,t){if(t.isA("sap.ui.table.AnalyticalColumn")){var i=e.getAnalyticalQueryResult();var n=i.getEntityType();var o=e.getModel().getProperty("/#"+n.getTypeDescription().name+"/"+t.getLeadingProperty()+"/sap:visible");if(o&&(o.value==="false"||o.value===false)){return true}}return false}s.prototype._updateColumnVisibilityMenuItem=function(){var e=this._getTable();if(!e||!e._oColumnVisibilityMenuItem){return}var t=e._oColumnVisibilityMenuItem.getSubmenu();if(!t){return}var i=m(e);var n=t.getItems();var o=e._getVisibleColumns();var u=e.getBinding();var r=l.isA(u,"sap.ui.model.analytics.AnalyticalBinding");for(var s=0;s<i.length;s++){var p=i[s];if(r){if(d(u,p)){continue}}var f=a.get(p);if(!f||f.bIsDestroyed){var f=this._createColumnVisibilityMenuItem(p);t.insertItem(f,s);a.set(p,f)}else{var g=n.indexOf(f);if(s!==g){t.removeItem(f);t.insertItem(f,s)}}var y=o.indexOf(p)>-1;var c=y?"sap-icon://accept":"";n=t.getItems();n[s].setProperty("icon",c);n[s].setEnabled(!y||o.length>1);n[s].removeAllAriaLabelledBy();n[s].addAriaLabelledBy(e.getId()+(y?"-ariahidecolmenu":"-ariashowcolmenu"))}for(var s=n.length;s>i.length;s--){n[s-1].destroy()}};return s});
//# sourceMappingURL=ColumnMenu.js.map