/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/i18n/Localization","sap/ui/integration/editor/fields/BaseField","sap/m/Input","sap/m/Text","sap/m/Title","sap/m/Select","sap/m/ComboBox","sap/m/Popover","sap/m/Button","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/ui/core/ListItem","sap/m/VBox","sap/base/util/each","sap/base/util/restricted/_debounce","sap/base/util/deepClone"],function(e,t,a,n,s,i,r,l,o,u,g,p,d,c,v,h){"use strict";var _=/parameters\.([^\}\}]+)/g;var f=["TODAY_ISO","NOW_ISO","LOCALE"];var T=t.extend("sap.ui.integration.editor.fields.StringField",{metadata:{library:"sap.ui.integration"},renderer:t.getMetadata().getRenderer()});T.prototype.initVisualization=function(t){var s=t.visualization;var l;if(!s){var o=t.value?t.value.match(_):undefined;var u,g,d;if(o&&o.length>0){o=o.filter(function(e){var t=e.substring(11);return!f.includes(t)})}if(o&&o.length>0){u=o.map(function(e){if(this.isOrigLangField){return"items>"+e.substring(11)+"/_language/value"}return"items>"+e.substring(11)+"/value"}.bind(this));u.unshift("currentSettings>value");g={parts:u,formatter:function(e){var t=Array.prototype.slice.call(arguments,1);for(var a=0;a<t.length;a++){if(t[a]){e=e.replaceAll("{{"+o[a]+"}}",t[a])}}return e}};d=function(e){var t=e.getSource().getValue();var a=this.getBindingContext("currentSettings").sPath;this._settingsModel.setProperty(a+"/value",t);var n=this._settingsModel.getBindings();var s=a.substring(a.lastIndexOf("/")+1);c(n,function(e,t){if(t.sPath==="/form/items/"+s+"/value"){t.checkUpdate(true)}})}.bind(this)}if(this.getMode()==="translation"){if(t.editable){s={type:a,settings:{value:{path:"currentSettings>value"},tooltip:{path:"currentSettings>value"},editable:t.editable,visible:t.visible,maxLength:t.maxLength,placeholder:t.placeholder}}}else{s={type:n,settings:{text:{path:"currentSettings>value"},tooltip:{path:"currentSettings>value"},visible:t.visible,wrapping:false}}}}else if(t.enum){l=new p({key:{path:"currentSettings>"},text:{path:"currentSettings>"}});s={type:i,settings:{selectedKey:{path:"currentSettings>value"},forceSelection:false,editable:t.editable,visible:t.visible,showSecondaryValues:false,width:"100%",items:{path:"currentSettings>enum",template:l}}}}else if(t.values){l=this.formatListItem(t.values.item);if(!t.values.item.key){t.values.item.key=t.values.item.text}s={type:r,settings:{busy:{path:"currentSettings>_loading"},selectedKey:{path:"currentSettings>value"},editable:t.editable,visible:t.visible,showSecondaryValues:true,width:"100%",items:{path:"",template:l}}};if(this.isFilterBackend()){s.settings.selectedKey={parts:["currentSettings>value","currentSettings>suggestValue"],formatter:function(e,t){if((!e||e==="")&&t){return t.replaceAll("''","'")}else{return e}}}}}else if(this.getMode()!=="translation"&&t.translatable){s={type:a,settings:{value:{path:"currentSettings>value"},tooltip:{path:"currentSettings>value"},editable:t.editable,visible:t.visible,maxLength:t.maxLength,placeholder:t.placeholder,valueHelpIconSrc:"sap-icon://translate",showValueHelp:true,valueHelpRequest:this.openTranslationListPopup.bind(this),change:function(a){var n=a.getSource();var s=n.getValue();var i=e.getLanguage().replaceAll("_","-");n.getParent().setTranslationValueInTexts(i,t.manifestpath,s)}}};if(u){delete s.settings.tooltip;s.settings.value=g;s.settings.change=d;s.settings.showValueHelp=false;delete s.settings.valueHelpRequest}}else{s={type:a,settings:{value:{path:"currentSettings>value"},tooltip:{path:"currentSettings>value"},editable:t.editable,visible:t.visible,maxLength:t.maxLength,placeholder:t.placeholder}};if(u){delete s.settings.tooltip;s.settings.value=g;s.settings.change=d}}}else if(s.type==="TextArea"){s.type="sap/m/TextArea"}else if(s.type==="Select"&&t.values){l=this.formatListItem(t.values.item);var v=Object.assign({selectedKey:{path:"currentSettings>value"},forceSelection:false,editable:t.editable,visible:t.visible,showSecondaryValues:false,width:"100%",items:{path:"",template:l}},s.settings||{});s={type:i,settings:v}}this._visualization=s;this.attachAfterInit(this._afterInit)};T.prototype._afterInit=function(){var e=this.getAggregation("_field");if(e instanceof r){if(this.isFilterBackend()){this.onInput=v(this.onInput,500);e.oninput=this.onInput.bind(this);e.attachSelectionChange(this.onSelectionChange.bind(this))}}};T.prototype.onSelectionChange=function(e){var t=e.getParameter("selectedItem")||{};var a=t.getKey();var n=this.getBindingContext("currentSettings").sPath;this._settingsModel.setProperty(n+"/value",a)};T.prototype.onInput=function(e){var t=e.target.value;var a=this.getBindingContext("currentSettings").sPath;this._settingsModel.setProperty(a+"/suggestValue",t.replaceAll("'","''"));this._settingsModel.setProperty(a+"/_loading",true);this._settingsModel.setProperty(a+"/value","");var n=this._settingsModel.getBindings();var s=a.substring(a.lastIndexOf("/")+1);c(n,function(e,t){if(t.sPath==="/form/items/"+s+"/value"){t.checkUpdate(true)}});var i=e.srcControl;i.open();i.setValue(t);i.setSelection(null)};T.prototype.getOriginTranslatedValues=function(e){var t=[];var a=this._oEditorResourceBundles.getResourceBundles();var n;if(e._translatedDefaultPlaceholder&&e._translatedDefaultPlaceholder.startsWith("{i18n>")&&e._translatedDefaultPlaceholder.endsWith("}")){n=e._translatedDefaultPlaceholder.substring(6,e._translatedDefaultPlaceholder.length-1)}else if(e._translatedDefaultPlaceholder&&e._translatedDefaultPlaceholder.startsWith("{{")&&e._translatedDefaultPlaceholder.endsWith("}}")){n=e._translatedDefaultPlaceholder.substring(2,e._translatedDefaultPlaceholder.length-2)}for(var s in a){var i=a[s];var r="";var l="";if(n&&i){var o=i.resourceBundle&&i.resourceBundle.getText(n,[],true);if(o!==undefined){r=o;l=o}else{r=e._translatedValue||"";l=e._translatedValue||""}}else{r=e._translatedDefaultPlaceholder||"";l=e._translatedDefaultPlaceholder||""}var u={key:s,description:i.language,value:r,originValue:l,editable:true};t.push(u)}return t};T.prototype.getTranslationValueInTexts=function(e,t){var a="/texts/"+e;var n=this._settingsModel.getProperty(a)||{};return n[t]};T.prototype.setTranslationValueInTexts=function(e,t,a){var n="/texts";var s=this._settingsModel.getData();if(!s){return}if(!s.hasOwnProperty("texts")){var i={};i[e]={};i[e][t]=a;this._settingsModel.setProperty(n,i)}else{n="/texts/"+e;var r;if(!s.texts.hasOwnProperty(e)){r={}}else{r=s.texts[e]}r[t]=a;this._settingsModel.setProperty(n,r)}};T.prototype.openTranslationListPopup=function(e){var t=this;var i=e.getSource();var r=i.getParent();var p=r.getParameterId();var c=r.getConfiguration();var v=r.getResourceBundle();var h=t.buildTranslationsData(r,i);var _;var f=r.getPopoverPlacement(i._oValueHelpIcon);if(!t._oTranslationPopover){var T=t.buildTranslationsList(p+"_translation_popover_value_list");t._oTranslationPopover=new l(p+"_translation_popover",{placement:f,contentWidth:"300px",contentHeight:"345px",customHeader:new d({items:[new s({text:v.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_TITLE")}).addStyleClass("sapMPopoverTitle"),new s({text:v.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_CURRENTLANGUAGE")}).addStyleClass("sapMHeaderTitle"),new d({items:[new n(p+"_translation_popover_currentlanguage_description_label",{text:"{languages>/currentLanguage/description}"}),new a(p+"_translation_popover_currentlanguage_value_input",{value:"{languages>/currentLanguage/value}",editable:false})]}).addStyleClass("sapMCurrentLanguageVBox"),new s({text:v.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_OTHERLANGUAGES")}).addStyleClass("sapMHeaderTitle")]}),content:T,footer:new u({content:[new g,new o(p+"_translation_popover_save_btn",{type:"Emphasized",text:v.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_BUTTON_SAVE"),enabled:"{languages>/isUpdated}",press:function(){var e=t._oTranslationPopover.getModel("languages").getData();var a=[];e.translatedLanguages.forEach(function(e){if(e.value!==e.originValue){r.setTranslationValueInTexts(e.key,c.manifestpath,e.value);a.push(e.key)}});if(e.currentLanguage.value!=e.currentLanguage.originValue){r.setTranslationValueInTexts(e.currentLanguage.key,c.manifestpath,e.currentLanguage.value);a.push(e.currentLanguage.key)}if(a.length>0){t._aUpdatedLanguages=a}t._oTranslationPopover.close()}}),new o(p+"_translation_popover_cancel_btn",{text:v.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_BUTTON_CANCEL"),press:function(){t._oTranslationPopover.close()}})]})}).addStyleClass("sapUiIntegrationFieldTranslation");_=t.buildTranslationsModel(h);t._oTranslationPopover.setModel(_,"languages")}else{t._oTranslationPopover.setPlacement(f);_=t._oTranslationPopover.getModel("languages");_.setData(h);_.checkUpdate(true)}t._oTranslationPopover.openBy(i._oValueHelpIcon)};T.prototype.buildTranslationsData=function(e,t){var a=this;var n=e.getConfiguration();if(!a._aOriginTranslatedValues){a._aOriginTranslatedValues=e.getOriginTranslatedValues(n)}var s=h(a._aOriginTranslatedValues,500);var i=e.getResourceBundle();s.forEach(function(t){var s=e.getTranslationValueInTexts(t.key,n.manifestpath);if(s){t.value=s;if(Array.isArray(a._aUpdatedLanguages)&&!a._aUpdatedLanguages.includes(t.key)){t.originValue=t.value}}else if(n._beforeLayerChange){t.value=n._beforeLayerChange;if(Array.isArray(a._aUpdatedLanguages)&&!a._aUpdatedLanguages.includes(t.key)){t.originValue=t.value}}t.status=i.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_NOTUPDATED");if(t.key===i.sLocale.replaceAll("_","-")){t.editable=false}});var r={currentLanguage:{},isUpdated:false,translatedLanguages:[]};if(s){s.forEach(function(s){if(Array.isArray(a._aUpdatedLanguages)&&a._aUpdatedLanguages.includes(s.key)){s.value=e.getTranslationValueInTexts(s.key,n.manifestpath);s.status=i.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_UPDATED")}if(s.key===i.sLocale.replaceAll("_","-")){s.value=t.getValue();r.currentLanguage=s}else{r.translatedLanguages.push(s)}})}return r};return T});
//# sourceMappingURL=StringField.js.map