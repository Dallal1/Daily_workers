/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/strings/capitalize","sap/base/Log","sap/m/MessageBox","sap/m/MessageToast","sap/ui/thirdparty/jquery","sap/ui/base/ManagedObject","sap/ui/core/BusyIndicator","sap/ui/core/Lib","sap/ui/dt/DesignTime","sap/ui/dt/DOMUtil","sap/ui/dt/ElementUtil","sap/ui/dt/Overlay","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/events/KeyCodes","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/initial/api/Version","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/ui/fl/write/api/ControlPersonalizationWriteAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/write/api/ReloadInfoAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/TranslationAPI","sap/ui/fl/Layer","sap/ui/fl/registry/Settings","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ui/rta/appVariant/Feature","sap/ui/rta/command/BaseCommand","sap/ui/rta/command/LREPSerializer","sap/ui/rta/command/Stack","sap/ui/rta/toolbar/Fiori","sap/ui/rta/toolbar/FioriLike","sap/ui/rta/toolbar/Personalization","sap/ui/rta/toolbar/Standalone","sap/ui/rta/util/changeVisualization/ChangeVisualization","sap/ui/rta/util/PluginManager","sap/ui/rta/util/PopupManager","sap/ui/rta/util/ReloadManager","sap/ui/rta/util/ServiceManager","sap/ui/rta/util/validateFlexEnabled","sap/ui/rta/Utils","sap/ui/Device"],function(t,e,i,n,jQuery,o,a,s,r,l,c,d,h,g,u,p,f,S,m,y,C,_,b,A,v,R,E,M,T,P,w,D,I,O,L,V,N,x,U,k,B,F,G,z,K,H){"use strict";const W="STARTING";const $="STARTED";const j="STOPPED";const Y="FAILED";const q=o.extend("sap.ui.rta.RuntimeAuthoring",{metadata:{library:"sap.ui.rta",associations:{rootControl:{type:"sap.ui.base.ManagedObject"}},properties:{showToolbars:{type:"boolean",defaultValue:true},triggeredFromDialog:{type:"boolean",defaultValue:false},showWindowUnloadDialog:{type:"boolean",defaultValue:true},commandStack:{type:"any"},flexSettings:{type:"object",defaultValue:{layer:R.CUSTOMER,developerMode:true}},mode:{type:"string",defaultValue:"adaptation"},metadataScope:{type:"string",defaultValue:"default"}},events:{start:{parameters:{editablePluginsCount:{type:"int"}}},stop:{},failed:{parameters:{error:{type:"any"}}},selectionChange:{parameters:{selection:{type:"sap.ui.dt.Overlay[]"}}},modeChanged:{},undoRedoStackModified:{}}},_sAppTitle:null,_dependents:null,_sStatus:j,_bNavigationModeWarningShown:false,constructor:function(...t){o.apply(this,t);this._dependents={};this._mUShellServices={};this._pElementModified=Promise.resolve();this.addDependent(new k,"pluginManager");this.addDependent(new B,"popupManager");this.addDependent(new G,"serviceManager");if(this.getShowToolbars()){this.getPopupManager().attachOpen(X,this);this.getPopupManager().attachClose(tt,this);this.addDependent(new U,"changeVisualization")}this.pServices=Promise.resolve();if(window.parent!==window){this.pServices=this.getService("receiver")}this.pServices=this.pServices.then(this.getService.bind(this,"supportTools"));this._loadUShellServicesPromise=M.getUShellServices(["URLParsing","AppLifeCycle","Navigation"]).then(function(t){this._mUShellServices=t;F.setUShellServices(t)}.bind(this))}});q.prototype.addDependent=function(e,i,n){n=typeof n==="undefined"?true:!!n;if(!(i in this._dependents)){if(i&&n){this[`get${t(i,0)}`]=this.getDependent.bind(this,i)}this._dependents[i||e.getId()]=e}else{throw g.createError("RuntimeAuthoring#addDependent",`Can't add dependency with same key '${i}'`,"sap.ui.rta")}};q.prototype.getDependent=function(t){return this._dependents[t]};q.prototype.getDependents=function(){return this._dependents};q.prototype.removeDependent=function(t){delete this._dependents[t]};q.prototype.setPlugins=function(t){if(this._sStatus!==j){throw Error("Cannot replace plugins: runtime authoring already started")}this.getPluginManager().setPlugins(t)};q.prototype.getPlugins=function(){return this.getPluginManager&&this.getPluginManager()&&this.getPluginManager().getPlugins()};q.prototype.getDefaultPlugins=function(){return this.getPluginManager().getDefaultPlugins(this.getFlexSettings())};q.prototype.setFlexSettings=function(t){const e=new URLSearchParams(window.location.search);const i=e.get("sap-ui-layer");t=Object.assign({},this.getFlexSettings(),t);if(i){t.layer=i.toUpperCase()}if(t.scenario||t.baseId){const e=M.buildLrepRootNamespace(t.baseId,t.scenario,t.projectId);t.rootNamespace=e;t.namespace=`${e}changes/`}K.setRtaStyleClassName(t.layer);this.setProperty("flexSettings",t)};q.prototype.getLayer=function(){return this.getFlexSettings().layer};q.prototype.getRootControlInstance=function(){this._oRootControl||=c.getElementInstance(this.getRootControl());return this._oRootControl};q.prototype._getTextResources=function(){return s.getResourceBundleFor("sap.ui.rta")};q.prototype.start=async function(){if(this._sStatus!==j){throw Error("RuntimeAuthoring is already started")}this._sStatus=W;const t=this.getRootControlInstance();if(!t){throw Error("Root control not found")}try{await this._loadUShellServicesPromise;await Pt.call(this);await wt.call(this,q.needsRestart(this.getLayer()));const t=await F.handleReloadOnStart({layer:this.getLayer(),selector:this.getRootControlInstance(),versioningEnabled:this._oVersionsModel.getProperty("/versioningEnabled"),developerMode:this.getFlexSettings().developerMode,adaptationId:this._oContextBasedAdaptationsModel.getProperty("/displayedAdaptation/id")});if(t){throw Error("Reload triggered")}_.setAdaptationLayer(this.getLayer(),this.getRootControlInstance());const e=_.getResetAndPublishInfoFromSession(this.getRootControlInstance());this.bInitialResetEnabled=!!e.isResetEnabled;this._oSerializer=new I({commandStack:this.getCommandStack(),rootControl:this.getRootControl()});this.getPluginManager().preparePlugins(this.getFlexSettings(),Nt.bind(this),this.getCommandStack());const i=Z.call(this);this._oldUnloadHandler=window.onbeforeunload;window.onbeforeunload=this._onUnload.bind(this);if(this.getShowToolbars()){const t=await at(this.getRootControlInstance(),this.getLayer(),this._oSerializer);await Dt.call(this,t)}await rt.call(this);d.getOverlayContainer().get(0).style.setProperty("--sap-ui-rta-scrollbar-scrollWidth",`${l.getScrollbarWidth()}px`);d.getOverlayContainer().get(0).style.setProperty("--sap-ui-rta-scrollbar-scrollWidthPlusTwo",`${l.getScrollbarWidth()+2}px`);await i;if(this.getChangeVisualization){this.getChangeVisualization()._oDesignTime=this._oDesignTime}this.getPopupManager().setRta(this);if(this.getShowToolbars()){await this.getToolbar().show()}if(H.browser.name==="ff"){jQuery(document).on("contextmenu",ot)}this.fnKeyDown=dt.bind(this);jQuery(document).on("keydown",this.fnKeyDown);this.fnOnPersonalizationChangeCreation=et.bind(this);y.attachChangeCreation(this.getRootControlInstance(),this.fnOnPersonalizationChangeCreation);await Q.call(this);this._sStatus=$;q.disableRestart(this.getLayer());this.fireStart({editablePluginsCount:this.getPluginManager().getEditableOverlaysCount()});await this.pServices}catch(t){if(t.message==="Reload triggered"){this.destroy()}else{this._sStatus=Y;this.fireFailed({vError:t.message})}throw Error(t.message)}};function Z(){const t=this.getPluginManager().getPluginList();return new Promise(function(e,i){P.start("rta.dt.startup","Measurement of RTA: DesignTime start up");this._oDesignTime=new r({scope:this.getMetadataScope(),plugins:t});nt(this.getRootControlInstance(),true);this._oDesignTime.addRootElement(this._oRootControl);d.getOverlayContainer().get(0).classList.add("sapUiRta");if(this.getLayer()===R.USER){d.getOverlayContainer().get(0).classList.add("sapUiRtaPersonalize")}else{document.body.classList.add("sapUiRtaMode")}this._oDesignTime.getSelectionManager().attachChange(function(t){this.fireSelectionChange({selection:t.getParameter("selection")})},this);this._oDesignTime.attachEventOnce("synced",function(){e();P.end("rta.dt.startup","Measurement of RTA: DesignTime start up")},this);this._oDesignTime.attachEventOnce("syncFailed",function(t){i(t.getParameter("error"))})}.bind(this))}function J(){const t=this._oVersionsModel.getProperty("/versioningEnabled");const e=t?"MSG_UNSAVED_DRAFT_CHANGES_ON_CLOSE":"MSG_UNSAVED_CHANGES_ON_CLOSE";const i=t?"BTN_UNSAVED_DRAFT_CHANGES_ON_CLOSE_SAVE":"BTN_UNSAVED_CHANGES_ON_CLOSE_SAVE";return K.showMessageBox("warning",e,{titleKey:"TIT_UNSAVED_CHANGES_ON_CLOSE",actionKeys:[i,"BTN_UNSAVED_CHANGES_ON_CLOSE_DONT_SAVE"],emphasizedActionKey:"BTN_UNSAVED_CHANGES_ON_CLOSE_SAVE",showCancel:true})}q.prototype.stop=async function(t,e){let n;lt.call(this,"setBusy",true);try{await ct.call(this);const o=this.getLayer();if(o!==R.USER&&!t&&this.canSave()){const t=await J.call(this);if(t===i.Action.CANCEL){n=true;throw Error()}if(t===this._getTextResources().getText("BTN_UNSAVED_CHANGES_ON_CLOSE_DONT_SAVE")){await this._oSerializer.clearCommandStack(true)}}const a=e?{}:await F.checkReloadOnExit({layer:this.getLayer(),selector:this.getRootControlInstance(),isDraftAvailable:this._oVersionsModel.getProperty("/draftAvailable"),versioningEnabled:this._oVersionsModel.getProperty("/versioningEnabled"),activeVersion:this._oVersionsModel.getProperty("/activeVersion"),changesNeedReloadPromise:this._bSavedChangesNeedReload?Promise.resolve(true):this._oSerializer.needsReload()});if(!t){await this._serializeToLrep(false,true)}lt.call(this,"hide",t);this.fireStop();if(!e){F.handleReloadOnExit(a)}A.clearInstances()}catch(t){if(!n){st(t)}}lt.call(this,"setBusy",false);if(!n){this._sStatus=j;document.body.classList.remove("sapUiRtaMode")}};q.prototype.setCommandStack=function(t){const e=this.getProperty("commandStack");if(e){e.detachModified(rt,this)}if(this._oInternalCommandStack){this._oInternalCommandStack.destroy();delete this._oInternalCommandStack}const i=this.setProperty("commandStack",t);if(t){t.attachModified(rt,this)}if(this.getPluginManager&&this.getPluginManager()){this.getPluginManager().provideCommandStack("settings",t)}return i};q.prototype.getCommandStack=function(){let t=this.getProperty("commandStack");if(!t){t=new O;this._oInternalCommandStack=t;this.setCommandStack(t)}return t};q.prototype.setMode=function(t){const e=this.getMode();if(e!==t){const i=this.getPluginManager().getPlugin("tabHandling");const n=this.getPluginManager().getPlugin("selection");if(e==="navigation"||t==="navigation"){this._oDesignTime.setEnabled(t!=="navigation");i[t==="navigation"?"restoreTabIndex":"removeTabIndex"]()}const o=this.getChangeVisualization?.();if(t==="visualization"||e==="visualization"){g.waitForSynced(this._oDesignTime)().then(function(){return o.triggerModeChange(this.getRootControl(),this.getToolbar())}.bind(this))}if(e==="adaptation"){this.getPluginManager().handleStopCutPaste()}i[t==="adaptation"?"restoreOverlayTabIndex":"removeOverlayTabIndex"]();n.setIsActive(!(t==="visualization"));d.getOverlayContainer().toggleClass("sapUiRtaVisualizationMode",t==="visualization");if(t==="visualization"){document.querySelectorAll(".sapUiDtOverlayMovable").forEach(function(t){t.style.cursor="default"})}else{document.querySelectorAll(".sapUiDtOverlayMovable").forEach(function(t){t.style.cursor="move"})}this._oToolbarControlsModel.setProperty("/modeSwitcher",t);this.setProperty("mode",t);this.fireModeChanged({mode:t})}};q.prototype.setMetadataScope=function(t){if(this._sStatus!==j){e.error("sap.ui.rta: Failed to set metadata scope on RTA instance after RTA is started");return}this.setProperty("metadataScope",t)};q.prototype.destroy=function(...t){const e=Object.keys(this._dependents);e.forEach(function(t){this._dependents[t].destroy(true);this.removeDependent(t)}.bind(this));if(this._oDesignTime){this._oDesignTime.destroy();this._oDesignTime=null;jQuery(document).off("keydown",this.fnKeyDown);if(this.fnOnPersonalizationChangeCreation){y.detachChangeCreation(this.getRootControlInstance(),this.fnOnPersonalizationChangeCreation)}}if(this.getRootControlInstance()){nt(this.getRootControlInstance(),false)}this.setCommandStack(null);if(H.browser.name==="ff"){jQuery(document).off("contextmenu",ot)}window.onbeforeunload=this._oldUnloadHandler;o.prototype.destroy.apply(this,t)};q.needsRestart=function(t){return F.needsAutomaticStart(t)};q.enableRestart=function(t,e){F.enableAutomaticStart(t,e)};q.disableRestart=function(t){F.disableAutomaticStart(t)};q.willRTAStartAfterReload=function(t){return F.needsAutomaticStart(t||R.CUSTOMER)};q.prototype.getSelection=function(){if(this._oDesignTime){return this._oDesignTime.getSelectionManager().get()}return[]};q.prototype.restore=function(){const t=this.getLayer();const e=t===R.USER?"FORM_PERS_RESET_MESSAGE_PERSONALIZATION":"FORM_PERS_RESET_MESSAGE";const n=t===R.USER?"BTN_RESTORE":"FORM_PERS_RESET_TITLE";this.getPluginManager().handleStopCutPaste();return K.showMessageBox("warning",e,{titleKey:n,actions:[i.Action.OK,i.Action.CANCEL],emphasizedAction:i.Action.OK}).then(function(e){if(e===i.Action.OK){q.enableRestart(t,this.getRootControlInstance());return It.call(this)}return undefined}.bind(this))};q.prototype.undo=function(){this.getPluginManager().handleStopCutPaste();return this.getCommandStack().undo()};q.prototype.redo=function(){this.getPluginManager().handleStopCutPaste();return this.getCommandStack().redo()};q.prototype.canUndo=function(){return this.getCommandStack().canUndo()};q.prototype.canSave=function(){return this.getCommandStack().canSave()};q.prototype.canRedo=function(){return this.getCommandStack().canRedo()};q.prototype.save=function(){return ct.call(this).then(this._serializeToLrep.bind(this))};q.prototype._serializeToLrep=function(t,e,i){if(!this._bSavedChangesNeedReload){return this._oSerializer.needsReload().then(function(n){this._bSavedChangesNeedReload=n;return gt.call(this,i,t,e)}.bind(this))}return gt.call(this,i,t,e)};q.prototype.condenseAndSaveChanges=function(...t){return this._serializeToLrep(...t)};q.prototype._onUnload=function(){if(this.canSave()&&this.getShowWindowUnloadDialog()){return this._getTextResources().getText("MSG_UNSAVED_CHANGES")}window.onbeforeunload=this._oldUnloadHandler;return undefined};async function Q(){const t=new URLSearchParams(window.location.search).get("sap-ui-rta-skip-flex-validation");const e=await E.getInstance();if(!e.isCustomerSystem()&&t!=="true"){z(this)}}function X(t){const e=t.getParameters().getSource();if(e.isA("sap.m.Dialog")&&this.getToolbar().type==="fiori"){this.getToolbar().setColor("contrast")}this.getToolbar().bringToFront()}function tt(t){if(t.getParameters().isA("sap.m.Dialog")){this.getToolbar().setColor()}}function et(){if(this.getMode()==="navigation"&&!this._bNavigationModeWarningShown){it.call(this,"MSG_NAVIGATION_MODE_CHANGES_WARNING",{duration:5e3});this._bNavigationModeWarningShown=true}}function it(t,e){const i=this._getTextResources().getText(t);n.show(i,e||{})}function nt(t,e){if(t.isA("sap.ui.core.UIComponent")){t=t.getRootControl()}if(t){t[e?"addStyleClass":"removeStyleClass"]("sapUiRtaRoot")}}function ot(){return false}async function at(t,e,i){const n=await C.isPublishAvailable();const o=await w.isSaveAsAvailable(t,e,i);const a=await C.isContextBasedAdaptationAvailable(e);const s=await M.getUShellService("AppLifeCycle");const r=s?.getCurrentApplication()?.homePage||false;const l=M.getAppDescriptor(t);const c=l&&!p.getOvpEntry(l);return{publishAvailable:n,saveAsAvailable:!r&&n&&o,contextBasedAdaptationAvailable:!r&&c&&a}}function st(t){a.hide();const n=t.userMessage||t.stack||t.message||t.status||t;const o=s.getResourceBundleFor("sap.ui.rta");e.error("Failed to transfer changes",n);const r=`${o.getText("MSG_LREP_TRANSFER_ERROR")}\n\t\t\t${o.getText("MSG_ERROR_REASON",[n])}`;i.error(r,{styleClass:K.getRtaStyleClassName()})}function rt(){const t=!this.getShowToolbars()||!this.getCommandStack().canUndo();K.checkDraftOverwrite(this._oVersionsModel,t).then(()=>{if(this.getShowToolbars()){const t=this.getCommandStack();const e=t.canUndo();const i=t.canRedo();const n=t.canSave();const o=t.getSaved();const a=this._oToolbarControlsModel.getProperty("/translation/visible")&&v.hasTranslationRelevantDirtyChanges({layer:R.CUSTOMER,selector:this.getRootControlInstance()});this._oVersionsModel.setDirtyChanges(_.hasDirtyChanges({selector:this.getRootControlInstance()}));this._oToolbarControlsModel.setProperty("/undo/enabled",e);this._oToolbarControlsModel.setProperty("/redo/enabled",i);this._oToolbarControlsModel.setProperty("/save/enabled",n);this._oToolbarControlsModel.setProperty("/restore/enabled",this.bInitialResetEnabled||n||o);this._oToolbarControlsModel.setProperty("/translation/enabled",this.bPersistedDataTranslatable||a)}this.fireUndoRedoStackModified()}).catch(()=>{this.undo()})}function lt(t,e){if(this.getShowToolbars()&&this.getToolbar&&this.getToolbar()){return this.getToolbar()[t](e)}return undefined}async function ct(){await(this._oDesignTime?.waitForBusyPlugins());return this._pElementModified}function dt(t){const e=H.os.macintosh;const i=d.getOverlayContainer().get(0).contains(document.activeElement);const n=this.getShowToolbars()&&this.getToolbar().getDomRef().contains(document.activeElement);let o=false;document.querySelectorAll(".sapUiDtContextMenu").forEach(function(t){if(t.contains(document.activeElement)){o=true}});const a=document.body===document.activeElement;const s=l.getParents(document.activeElement,".sapUiRtaEditableField").length>0;if((i||n||o||a)&&!s){const i=e?t.metaKey:t.ctrlKey;if(t.keyCode===u.Z&&t.shiftKey===false&&t.altKey===false&&i===true){this.undo().then(t.stopPropagation.bind(t))}else if((e&&t.keyCode===u.Z&&t.shiftKey===true||!e&&t.keyCode===u.Y&&t.shiftKey===false)&&t.altKey===false&&i===true){this.redo().then(t.stopPropagation.bind(t))}}}function ht(t){const e=t.getParameter("callback")||function(){};const i=this._oVersionsModel.getProperty("/versioningEnabled");return this.save().then(function(){it.call(this,i?"MSG_SAVE_DRAFT_SUCCESS":"MSG_SAVE_SUCCESS",{duration:5e3})}.bind(this)).catch(function(t){return st(t)}).then(e)}async function gt(t,e,i){if(this.getShowToolbars()){this.bPersistedDataTranslatable=this._oToolbarControlsModel.getProperty("/translation/enabled")}const n={layer:this.getLayer(),removeOtherLayerChanges:true,condenseAnyLayer:e};if(this._oVersionsModel.getProperty("/versioningEnabled")){let e=t?this._oVersionsModel.getProperty("/displayedVersion"):undefined;e||=i?undefined:S.Number.Draft;n.version=e;n.saveAsDraft=this.getLayer()===R.CUSTOMER}if(this._oContextBasedAdaptationsModel.getProperty("/contextBasedAdaptationsEnabled")){n.adaptationId=i?undefined:this._oContextBasedAdaptationsModel.getProperty("/displayedAdaptation/id")}await this._oSerializer.saveCommands(n);if(!i&&this.getChangeVisualization){const t=this.getToolbar();const e=this.getChangeVisualization();e.updateAfterSave(t)}}async function ut(t){const e=t.getParameter("versionTitle");if(Mt.call(this)&&Tt.call(this)){const t=await K.showMessageBox("warning","MSG_DRAFT_DISCARD_ON_REACTIVATE_DIALOG",{titleKey:"TIT_DRAFT_DISCARD_ON_REACTIVATE_DIALOG",actions:[i.Action.OK,i.Action.CANCEL],emphasizedAction:i.Action.OK});if(t===i.Action.OK){return pt.call(this,e)}}return pt.call(this,e)}async function pt(t){const e=this.getLayer();const i=this.getRootControlInstance();const n=this._oVersionsModel.getProperty("/displayedVersion");try{await this._serializeToLrep(false,false,true);await A.activate({layer:e,control:i,title:t,displayedVersion:n});it.call(this,"MSG_DRAFT_ACTIVATION_SUCCESS");this.bInitialResetEnabled=true;this._oToolbarControlsModel.setProperty("/restore/enabled",true);this.getCommandStack().removeAllCommands()}catch(t){K.showMessageBox("error","MSG_DRAFT_ACTIVATION_FAILED",{error:t})}}async function ft(){const t=await K.showMessageBox("warning","MSG_DRAFT_DISCARD_DIALOG",{actions:[i.Action.OK,i.Action.CANCEL],emphasizedAction:i.Action.OK});if(t===i.Action.OK){await A.discardDraft({layer:this.getLayer(),control:this.getRootControlInstance(),updateState:true});await St.call(this)}}function St(){const t=this.getLayer();const e={layer:t,removeDraft:true,selector:this.getRootControlInstance()};q.enableRestart(t,this.getRootControlInstance());this.getCommandStack().removeAllCommands();F.triggerReload(e);return this.stop(true,true)}function mt(){if(this.canSave()){yt.call(this,"DAC_DATA_LOSS_DIALOG_DESCRIPTION","DAC_DIALOG_HEADER",true)}else{yt.call(this,"DAC_DIALOG_DESCRIPTION","DAC_DIALOG_HEADER")}}function yt(t,e,n){K.showMessageBox("confirm",t,{titleKey:e}).then(function(t){if(t===i.Action.OK){a.show();if(n){this.getCommandStack().removeAllCommands(true)}Ct.call(this)}}.bind(this))}function Ct(){P.start("onCBADeleteAdaptation","Measurement of deleting a context-based adaptation");m.remove({control:this.getRootControlInstance(),layer:this.getLayer(),adaptationId:this._oContextBasedAdaptationsModel.getProperty("/displayedAdaptation/id")}).then(function(){a.hide();const t=this._oContextBasedAdaptationsModel.deleteAdaptation();At.call(this,t);P.end("onCBADeleteAdaptation");if(P.getActive()){e.info(`onCBADeleteAdaptation: ${P.getMeasurement("onCBADeleteAdaptation").time} ms`)}}.bind(this)).catch(function(t){a.hide();e.error(t.stack);const i="MSG_LREP_TRANSFER_ERROR";const n={titleKey:"DAC_DIALOG_HEADER"};n.details=t.userMessage;K.showMessageBox("error",i,n)})}async function _t(t,e,n){if(this.canSave()){const o=await K.showMessageBox("warning",t,{titleKey:e,actions:[i.Action.YES,i.Action.NO,i.Action.CANCEL],emphasizedAction:i.Action.YES});if(o===i.Action.YES){await this._serializeToLrep();await n()}else if(o===i.Action.NO){this.getCommandStack().removeAllCommands(true);await n()}}else{await n()}}function bt(t){P.start("onCBASwitchAdaptation","Measurement of switching a context-based adaptation");const i=t.getParameter("callback")||function(){};if(t.getParameter("trigger")==="SaveAs"){this.getCommandStack().removeAllCommands(true)}const n=t.getParameter("adaptationId");this._sSwitchToAdaptationId=n;return _t.call(this,"MSG_SWITCH_VERSION_DIALOG","BTN_SWITCH_ADAPTATIONS",At.bind(this,this._sSwitchToAdaptationId)).then(function(){i();P.end("onCBASwitchAdaptation");if(P.getActive()){e.info(`onCBASwitchAdaptation: ${P.getMeasurement("onCBASwitchAdaptation").time} ms`)}}).catch(function(t){K.showMessageBox("error","MSG_SWITCH_ADAPTATION_FAILED",{error:t});e.error(`sap.ui.rta: ${t.stack||t.message||t}`)})}function At(t){const e=this._oVersionsModel.getProperty("/displayedVersion");return Rt.call(this,e,t)}function vt(t){const i=t.getParameter("callback")||function(){};const n=t.getParameter("version");const o=this._oVersionsModel.getProperty("/displayedVersion");if(n===o){return}this._sSwitchToVersion=n;_t.call(this,"MSG_SWITCH_VERSION_DIALOG","TIT_SWITCH_VERSION_DIALOG",Rt.bind(this,this._sSwitchToVersion)).then(i).catch(function(t){K.showMessageBox("error","MSG_SWITCH_VERSION_FAILED",{error:t});e.error(`sap.ui.rta: ${t.stack||t.message||t}`)})}function Rt(t,e){q.enableRestart(this.getLayer(),this.getRootControlInstance());return A.loadVersionForApplication({control:this.getRootControlInstance(),layer:this.getLayer(),version:t,adaptationId:e}).then(function(){const e={versionSwitch:true,version:t,selector:this.getRootControlInstance()};F.triggerReload(e)}.bind(this))}function Et(){this.getPluginManager().handleStopCutPaste();return A.publish({selector:this.getRootControlInstance(),styleClass:K.getRtaStyleClassName(),layer:this.getLayer(),version:this._oVersionsModel.getProperty("/displayedVersion")}).then(function(t){if(t!=="Error"&&t!=="Cancel"){n.show(t)}})}function Mt(){return A.isOldVersionDisplayed({control:this.getRootControlInstance(),layer:this.getLayer()})}function Tt(){return A.isDraftAvailable({control:this.getRootControlInstance(),layer:this.getLayer()})}function Pt(){return A.initialize({control:this.getRootControlInstance(),layer:this.getLayer()}).then(function(t){this._oVersionsModel=t}.bind(this))}function wt(t){if(!t){m.clearInstances()}return m.initialize({control:this.getRootControlInstance(),layer:this.getLayer()}).then(function(t){this._oContextBasedAdaptationsModel=t}.bind(this))}async function Dt(t){if(this.getDependent("toolbar")){return}const e=this.getLayer()===R.USER;const i={rtaInformation:{flexSettings:this.getFlexSettings(),rootControl:this.getRootControlInstance(),commandStack:this.getCommandStack()},textResources:this._getTextResources(),restore:this.restore.bind(this),exit:this.stop.bind(this,false,e)};if(!e){i.publishVersion=Et.bind(this);i.undo=this.undo.bind(this);i.redo=this.redo.bind(this);i.modeChange=xt.bind(this);i.activate=ut.bind(this);i.discardDraft=ft.bind(this);i.switchVersion=vt.bind(this);i.switchAdaptation=bt.bind(this);i.deleteAdaptation=mt.bind(this);i.openChangeCategorySelectionPopover=this.getChangeVisualization?this.getChangeVisualization().openChangeCategorySelectionPopover.bind(this.getChangeVisualization()):function(){};i.save=ht.bind(this)}let n;if(e){n=new N(i)}else if(K.isOriginalFioriToolbarAccessible()){n=new L(i)}else if(K.getFiori2Renderer()){n=new V(i)}else{n=new x(i)}this.addDependent(n,"toolbar");await n.onFragmentLoaded();const o=await C.isKeyUserTranslationEnabled(this.getLayer());const a=t.saveAsAvailable;const s=a&&w.isOverviewExtended();const r=new URLSearchParams(window.location.search);const l=!r.has("fiori-tools-rta-mode")||r.get("fiori-tools-rta-mode")==="false";const c=f.getConfiguredFlexServices().some(function(t){return t.connector!=="LocalStorageConnector"});this.bPersistedDataTranslatable=false;this._oToolbarControlsModel=new T({modeSwitcher:this.getMode(),undo:{enabled:false},redo:{enabled:false},save:{enabled:false},translation:{visible:o,enabled:this.bPersistedDataTranslatable},appVariantMenu:{visible:a,enabled:a,overview:{visible:a&&s,enabled:a&&s},manageApps:{visible:a&&!s,enabled:a&&!s},saveAs:{visible:a,enabled:a}},restore:{visible:!this._oVersionsModel.getProperty("/versioningEnabled"),enabled:this.bInitialResetEnabled},contextBasedAdaptation:{visible:t.contextBasedAdaptationAvailable,enabled:t.contextBasedAdaptationAvailable},actionsMenuButton:{enabled:true},visualizationButton:{visible:l,enabled:l},feedbackButton:{visible:c}});this._oVersionsModel.setProperty("/publishVersionVisible",t.publishAvailable);this.getToolbar().setModel(this._oVersionsModel,"versions");this.getToolbar().setModel(this._oContextBasedAdaptationsModel,"contextBasedAdaptations");this.getToolbar().setModel(this._oToolbarControlsModel,"controls");if(o){const t=await v.getSourceLanguages({selector:this.getRootControlInstance(),layer:this.getLayer()});this.bPersistedDataTranslatable=t.length>0;this._oToolbarControlsModel.setProperty("/translation/enabled",this.bPersistedDataTranslatable)}if(a){const t=M.isVariantByStartupParameter(this.getRootControlInstance())?false:await w.isManifestSupported();this._oToolbarControlsModel.setProperty("/appVariantMenu/saveAs/enabled",t);this._oToolbarControlsModel.setProperty("/appVariantMenu/overview/enabled",t);this._oToolbarControlsModel.setProperty("/appVariantMenu/manageApps/enabled",t)}}function It(){const t=this.getLayer();const e=M.getAppComponentForControl(this.getRootControlInstance());return _.reset({selector:e,layer:t}).then(function(){this.getCommandStack().removeAllCommands(true);b.removeInfoSessionStorage(e);const i={layer:t,ignoreMaxLayerParameter:true,triggerHardReload:true};return F.triggerReload(i)}.bind(this)).catch(function(t){if(t!=="cancel"){K.showMessageBox("error","MSG_RESTORE_FAILED",{error:t})}})}function Ot(t,e){function i(n){const o=n.getParameter("elementOverlay");if(o.getElement().getId()===t){this._oDesignTime.detachEvent("elementOverlayCreated",i,this);e(o)}}this._oDesignTime.attachEvent("elementOverlayCreated",i,this)}function Lt(t,e){function i(t){const n=t.getSource();if(n.getGeometry()&&n.getGeometry().visible){n.detachEvent("geometryChanged",i);e(n)}}function n(t){if(!t.getGeometry()||!t.getGeometry().visible){t.attachEvent("geometryChanged",i)}else{e(t)}}Ot.call(this,t,function(t){if(t.isRendered()){n(t)}else{t.attachEventOnce("afterRendering",function(t){n(t.getSource())})}})}function Vt(t,e,i){const n=function(t){t.setSelected(true);this.getPluginManager().getPlugin("rename").startEdit(t)}.bind(this);Lt.call(this,e,async function(e){const o=this.getPluginManager().getPlugin("createContainer").getCreatedContainerId(t,e.getElement().getId());const a=h.getOverlay(o);if(a){if(i){await this.getPluginManager().getPlugin("rename").createRenameCommand(a,i);this.getCommandStack().compositeLastTwoCommands()}else{n(a)}}else{Lt.call(this,o,n)}}.bind(this))}function Nt(t){const i=t.getParameter("command");const n=t.getParameter("newControlId");const o=t.getParameter("action");const a=t.getParameter("title");this._pElementModified=this._pElementModified.then(function(){this.getPluginManager().handleStopCutPaste();if(i instanceof D){if(n){Ot.call(this,n,function(t){const e=t.getDesignTimeMetadata();const i=e.getData().select;if(typeof i==="function"){i(t.getElement())}});if(o){Vt.call(this,o,n,a)}}return this.getCommandStack().pushAndExecute(i).catch(function(t){if(t?.message?.indexOf?.("The following Change cannot be applied because of a dependency")>-1){K.showMessageBox("error","MSG_DEPENDENCY_ERROR",{error:t})}e.error("sap.ui.rta:",t.message,t.stack)})}return undefined}.bind(this));return this._pElementModified}function xt(t){this.setMode(t.getParameter("item").getKey())}q.prototype.getService=function(t){if(this._sStatus!==$){return new Promise((t,e)=>{this.attachEventOnce("start",t);this.attachEventOnce("failed",e)}).then(()=>this.getServiceManager().startService(t,this)).catch(()=>{throw Error(g.createError("RuntimeAuthoring#getService",`Can't start the service '${t}' because RTA startup failed`,"sap.ui.rta"))})}return this.getServiceManager().startService(t,this)};return q});
//# sourceMappingURL=RuntimeAuthoring.js.map