/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/fl/Utils","sap/ui/rta/Utils"],function(e,t,n,a,r,i){"use strict";var o={};function g(e,t){var n;e.reveal.elements.some(function(e){if(e.element.getId()===t.getId()){n=e;return false}return undefined});return n}function d(t){var n=t.compositeCommand;var a=t.selectedElement;var r=t.parents;var i=t.siblingElement;var o=t.actions;var g=t.index;var d=t.targetAggregation;var v=t.plugin;return m(a,o,r,v).then(function(e){n.addCommand(e);return l(a,r,i,g,d,v)}).then(function(t){if(t){n.addCommand(t)}else{e.warning(`No move action configured for ${r.parent.getMetadata().getName()}, aggregation: ${a.aggregation}`,"sap.ui.rta")}return n})}function m(e,a,r,i){var o=t.getElementInstance(e.elementId);var d=n.getOverlay(o);var m=g(a,o);var l=m.designTimeMetadata;var v=m.action;var c;if(d){c=i.getVariantManagementReference(d)}if(v.changeOnRelevantContainer){return i.getCommandFactory().getCommandFor(o,"reveal",{revealedElementId:o.getId(),directParent:r.parent},l,c)}return i.getCommandFactory().getCommandFor(o,"reveal",{},l,c)}function l(e,a,r,o,g,d){var m=t.getElementInstance(e.elementId);var l=n.getOverlay(m);var v=e.sourceAggregation;var c=l.getParentElementOverlay().getElement()||a.parent;var s=a.parent;var u=i.getIndex(a.parent,r,g);var p=i.getIndex(c,m,v)-1;u=o!==undefined?o:t.adjustIndexForMove(c,s,p,u);if(u!==p||a.parent!==m.getParent()||v!==g){var f=n.getOverlay(m)?n.getOverlay(m).getParentAggregationOverlay():a.relevantContainerOverlay;var C=f.getDesignTimeMetadata();var y=d.getVariantManagementReference(l);return d.getCommandFactory().getCommandFor(a.relevantContainer,"move",{movedElements:[{element:m,sourceIndex:p,targetIndex:u}],source:{parent:c,aggregation:v},target:{parent:s,aggregation:g}},C,y)}return Promise.resolve()}function v(e,t){var n=e.getManifestEntry("/sap.ui5/dependencies/libs");return Object.keys(t).some(function(e){return!n[e]||n[e].lazy})}function c(e,t,n,a){if(t){var i=r.getAppComponentForControl(e.relevantContainer);var o=v(i,t);if(o){var g=i.getManifest();var d=g["sap.app"].id;return a.getCommandFactory().getCommandFor(e.publicParent,"addLibrary",{reference:d,parameters:{libraries:t},appComponent:i},n)}}return Promise.resolve()}function s(e){var t=e.compositeCommand;var n=e.actions.addViaDelegate.action;var a=n.delegateInfo.requiredLibraries;var r=e.parents.parentOverlay.getAggregationOverlay(e.actions.aggregation);var i=r.getDesignTimeMetadata();return c(e.parents,a,i,e.plugin).then(function(n){if(n){t.addCommand(n)}return f(e,i)}).then(function(e){if(e){t.addCommand(e)}return t})}function u(e){var t="";if(e){var n=e.getEntry?e.getEntry("sap.app"):e["sap.app"];if(n&&n.dataSources&&n.dataSources.mainService&&n.dataSources.mainService.uri){t=n.dataSources.mainService.uri}}return t}function p(e,t,n){return`${e.getId()}_${t}_${n}`.replace("/","_")}function f(e,t){var n=e.selectedElement;var a=e.parents;var o=e.siblingElement;var g=e.actions;var d=e.index;var m=e.plugin;var l=g.addViaDelegate.action;var v=l.changeOnRelevantContainer?a.relevantContainer:a.parent;var c=l.changeOnRelevantContainer?a.relevantContainerOverlay:a.parentOverlay;var s=m.getVariantManagementReference(c);var f=i.getIndex(a.parent,o,g.aggregation,t.getData().getIndex);var C="addDelegateProperty";var y=r.getAppComponentForControl(a.parent).getManifest();var b=u(y);return m.getCommandFactory().getCommandFor(a.parent,C,{newControlId:p(v,n.entityType,n.bindingPath),index:d!==undefined?d:f,bindingString:n.bindingPath,entityType:n.entityType,parentId:a.parent.getId(),propertyName:n.name,oDataServiceVersion:n.oDataServiceVersion,oDataServiceUri:b,modelType:l.delegateInfo.modelType,relevantContainerId:a.relevantContainer.getId()},t,s)}o.createCommands=function(t,n,r,i,o,g,m){o.sort(function(e,t){if(e.label>t.label){return-1}if(e.label<t.label){return 1}return 0});if(o.length>0){return m.getCommandFactory().getCommandFor(t.parent,"composite").then(function(a){var l=Promise.resolve();o.forEach(function(o){var v={compositeCommand:a,selectedElement:o,parents:t,siblingElement:n,actions:r,index:i,targetAggregation:g,plugin:m};switch(o.type){case"invisible":l=l.then(d.bind(this,v));break;case"delegate":l=l.then(s.bind(this,v));break;default:e.error(`Can't create command for untreated element.type ${o.type}`)}},this);return l.then(function(){return a})}.bind(this)).then(function(e){m.fireElementModified({command:e})}).catch(function(e){throw a.propagateError(e,"AdditionalElementsPlugin#_createCommands","Error occurred during _createCommands execution","sap.ui.rta.plugin")})}return Promise.resolve()};return o});
//# sourceMappingURL=CommandBuilder.js.map