/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/Utils","sap/ui/fl/write/api/ContextSharingAPI","sap/ui/rta/command/BaseCommand","sap/ui/rta/library","sap/ui/rta/Utils"],function(e,t,a,n,r,i){"use strict";var o=n.extend("sap.ui.rta.command.ControlVariantSaveAs",{metadata:{library:"sap.ui.rta",properties:{sourceVariantReference:{type:"string"},sourceDefaultVariant:{type:"string"},model:{type:"object"},newVariantParameters:{type:"object"}},associations:{},events:{}}});o.prototype.prepare=function(n){this.oVariantManagementControl=this.getElement();this.oAppComponent=t.getAppComponentForControl(this.oVariantManagementControl);this.sVariantManagementReference=e.getSelector(this.oVariantManagementControl,this.oAppComponent).id;this.oModel=this.getModel();this.setSourceDefaultVariant(this.oModel.getData()[this.sVariantManagementReference].defaultVariant);this.sLayer=n.layer;var r=n;r.variantManagementControl=this.oVariantManagementControl;function o(e,t){var a=e.getParameters();this.setNewVariantParameters(a);this.oVariantManagementControl.detachSave(o,this);this.oVariantManagementControl.detachCancel(s,this);t.resolve(true)}function s(e,t){this.oVariantManagementControl.detachSave(o,this);this.oVariantManagementControl.detachCancel(s,this);t.resolve(false)}return new Promise(function(e){this.oVariantManagementControl.attachSave({resolve:e},o,this);this.oVariantManagementControl.attachCancel({resolve:e},s,this);this.oVariantManagementControl.openSaveAsDialogForKeyUser(i.getRtaStyleClassName(),a.createComponent(r))}.bind(this)).then(function(e){return e})};o.prototype.getPreparedChange=function(){if(!this._aPreparedChanges){return undefined}return this._aPreparedChanges};o.prototype.execute=function(){var e=this.getSourceVariantReference();this._aControlChangesWithoutVariant=this.oModel.getVariant(e,this.sVariantManagementReference).controlChanges.filter(e=>!e.getSavedToVariant());var t=this.getNewVariantParameters();t.layer=this.sLayer;t.newVariantReference=this.sNewVariantReference;t.generator=r.GENERATOR_NAME;return this.oModel._handleSave(this.oVariantManagementControl,t).then(function(e){this._aPreparedChanges=e;[this._oVariantChange]=e;this.sNewVariantReference=this._oVariantChange.getId();this._aPreparedChanges.forEach(function(e){if(e.getFileType()==="change"){e.setSavedToVariant(true)}});this.getModel().invalidateMap()}.bind(this))};o.prototype.undo=function(){if(this._oVariantChange){var e=[];this._aPreparedChanges.forEach(function(t){if(t.getFileType()==="ctrl_variant_management_change"){e.push(t)}});this.oModel.oChangePersistence.deleteChanges(e);var t={variant:this._oVariantChange,sourceVariantReference:this.getSourceVariantReference(),variantManagementReference:this.sVariantManagementReference,component:this.oAppComponent};return this.oModel.removeVariant(t,true).then(function(){const e=this._aControlChangesWithoutVariant;return this.oModel.addAndApplyChangesOnVariant(e)}.bind(this)).then(function(){this._aPreparedChanges=null;this._oVariantChange=null}.bind(this))}return Promise.resolve()};return o});
//# sourceMappingURL=ControlVariantSaveAs.js.map