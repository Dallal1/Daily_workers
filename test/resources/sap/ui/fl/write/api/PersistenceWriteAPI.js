/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/_internal/flexState/FlexObjectState","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/FlexControllerFactory","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,n,t,r,a,s,o,i,l,c,u,f,g,h,p,d,y){"use strict";var C={};function v(e){return e._getMap&&a.getChangeTypes().includes(e._getMap().changeType)||e.getChangeType&&a.getChangeTypes().includes(e.getChangeType())}function b(e){e.includeCtrlVariants=true;e.invalidateCache=false;return C._getUIChanges(e).then(function(e){return e.length>0})}C.hasDirtyChanges=function(e){return l.hasDirtyFlexObjects(e)};C.hasHigherLayerChanges=function(e){e.upToLayer||=d.getCurrentLayer();return l.getFlexObjects(e).then(function(n){return n.filter(function(n){return d.isOverLayer(n.getLayer(),e.upToLayer)})}).then(function(n){if(n.length===0){return false}return l.filterHiddenFlexObjects(n,e.reference).length>0})};C.save=function(e){var n=s.getFlexReferenceForControl(e.selector);var t=f.getByReference(n);t.saveChangeKeepSession=true;f.setByReference(t,n);return l.saveFlexObjects(e).then(function(r){if(r&&r.length!==0){return C.getResetAndPublishInfo(e).then(function(e){t=f.getByReference(n);delete t.saveChangeKeepSession;f.setByReference(Object.assign(t,e),n);return r})}t=f.getByReference(n);delete t.saveChangeKeepSession;f.setByReference(t,n);return r})};C.getResetAndPublishInfo=function(e){return Promise.all([b(e),u.isPublishAvailable()]).then(function(t){var r=t[0];var a=t[1];var s=e.layer!==p.USER&&e.layer!==p.PUBLIC;var o={isResetEnabled:r,isPublishEnabled:false,allContextsProvided:true};if(s){return c.getFlexInfo(e).then(function(e){o.allContextsProvided=e.allContextsProvided===undefined||e.allContextsProvided;o.isResetEnabled=e.isResetEnabled;o.isPublishEnabled=a&&e.isPublishEnabled;return o}).catch(function(e){n.error(`Sending request to flex/info route failed: ${e.message}`);return o})}return o})};C.getResetAndPublishInfoFromSession=function(e){var n=s.getFlexReferenceForControl(e)||"true";return JSON.parse(window.sessionStorage.getItem(`sap.ui.fl.info.${n}`))};C.reset=function(e){var n=y.getAppComponentForSelector(e.selector);var t=h.createForSelector(n);return t.resetChanges(e.layer,e.generator,n,e.selectorIds,e.changeTypes)};C.publish=function(e){e.styleClass||="";return g.getChangePersistenceForControl(y.getAppComponentForSelector(e.selector)).transportAllUIChanges({},e.styleClass,e.layer,e.appVariantDescriptors)};C.add=function(e){var n=y.getAppComponentForSelector(e.selector);var t=s.getFlexReferenceForSelector(e.selector);var r=g.getChangePersistenceForComponent(t);function a(e){if(v(e)){return e.store()}return r.addChange(e,n)}if(e.change&&e.flexObjects){throw new Error("Using 'flexObjects' and 'change' properties together not supported. Please use the 'flexObjects' property.")}if(e.change){return a(e.change)}var o=e.flexObjects.some(function(e){return v(e)});if(o){return e.flexObjects.map(a)}return r.addChanges(e.flexObjects,n)};C.remove=function(e){return Promise.resolve().then(function(){if(e.change&&e.flexObjects){return Promise.reject(new Error("Using 'flexObjects' and 'change' properties together not supported. Please use the 'flexObjects' property."))}if(!e.selector){return Promise.reject(new Error(`An invalid selector was passed so change could not be removed with id: ${e.change.getId()}`))}var n=y.getAppComponentForSelector(e.selector);if(!n){return Promise.reject(new Error(`Invalid application component for selector, change could not be removed with id: ${e.change.getId()}`))}var a=g.getChangePersistenceForControl(n);function s(e){var a=t.bySelector(e.getSelector(),n);if(a){r.destroyAppliedCustomData(a,e,t)}}if(e.change){if(!v(e.change)){s(e.change)}return a.deleteChange(e.change)}e.flexObjects.forEach(function(e){if(!v(e)){s(e)}});return a.deleteChanges(e.flexObjects)})};C.getChangesWarning=function(e){return this._getUIChanges(e).then(function(e){var n=e.some(function(e){return e.isChangeFromOtherSystem()});var t=o.getInstanceOrUndef();var r=t&&t.isProductiveSystemWithTransports();var a=e.length===0;var s={showWarning:false};if(n){s={showWarning:true,warningType:"mixedChangesWarning"}}if(r&&a){s={showWarning:true,warningType:"noChangesAndPSystemWarning"}}return s})};C._condense=function(e){return Promise.resolve().then(function(){if(!e.selector){throw Error("An invalid selector was passed")}var n=y.getAppComponentForSelector(e.selector);if(!n){throw Error("Invalid application component for selector")}if(!e.changes||e.changes&&!Array.isArray(e.changes)){throw Error("Invalid array of changes")}return i.condense(n,e.changes)})};C._getUIChanges=function(e){if(e.layer){e.currentLayer=e.layer}return l.getFlexObjects(e)};C.setAdaptationLayer=function(e,n){const t=s.getFlexReferenceForControl(n);const r=f.getByReference(t);r.adaptationLayer=e;f.setByReference(r,t)};return C});
//# sourceMappingURL=PersistenceWriteAPI.js.map