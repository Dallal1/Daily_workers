/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/descriptorRelated/api/DescriptorChangeFactory","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/ui/fl/write/_internal/appVariant/AppVariantInlineChangeFactory","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/Utils"],function(e,t,n,a,r,c,i,o,l,p,s,g,f,h,u,C,d,m){"use strict";var y={};function S(e){var n;if(e.changeSpecificData.layer){n=e.changeSpecificData.layer;delete e.changeSpecificData.layer}const a={changeType:e.changeSpecificData.changeType,content:e.changeSpecificData.content};if(e.changeSpecificData.texts){a.texts=e.changeSpecificData.texts}return C.createDescriptorInlineChange(a).then(t=>(new f).createNew(e.changeSpecificData.reference,t,n,e.selector)).catch(e=>{t.error("the change could not be created.",e.message);throw e})}function D(e){const t=p.createUIChange(e.changeSpecificData);return h.getChangeHandler(t.getChangeType(),e.controlType,e.selector,n,t.getLayer()).then(a=>a.completeChangeContent(t,e.changeSpecificData,{modifier:n,appComponent:e.appComponent,view:m.getViewForControl(e.selector)})).then(()=>{t.setState(s.LifecycleState.NEW);return t})}y.create=function(e){if(e.changeSpecificData.changeType==="codeExt"){return p.createControllerExtensionChange(e.changeSpecificData)}const t=m.getAppComponentForSelector(e.selector.view||e.selector);const r=e.selector.appId||g.getFlexReferenceForControl(t);e.appComponent=t;e.changeSpecificData.reference=r;if(i.getChangeTypes().includes(e.changeSpecificData.changeType)){return S(e)}const c={layer:e.changeSpecificData.layer,control:t,reference:r};if(u.hasAdaptationsModel(c)){e.changeSpecificData.adaptationId=u.getDisplayedAdaptationId(c)}if(e.selector instanceof a){return Promise.resolve(p.createUIChange(e.changeSpecificData))}if(e.selector.name&&e.selector.view){e.changeSpecificData.selector={name:e.selector.name,viewSelector:n.getSelector(e.selector.view.getId(),t)};return D(e)}const o=e.selector.id||e.selector.getId();e.changeSpecificData.selector||={};Object.assign(e.changeSpecificData.selector,n.getSelector(o,t));e.controlType=e.selector.controlType||m.getControlType(e.selector);return D(e)};y.apply=function(t){if(!(t.element instanceof r)){return Promise.reject("Please provide an Element")}t.appComponent=m.getAppComponentForSelector(t.element);t.modifier||=n;return o.applyChangeOnControl(t.change,t.element,e(t,["element","change"])).then(function(e){var n=d.getChangePersistenceForControl(t.element);var a=n.getOpenDependentChangesForControl(t.change.getSelector(),t.appComponent);if(a.length>0){return y.revert({change:t.change,element:t.element}).then(function(){var e=c.getResourceBundleFor("sap.ui.fl");var n=a.map(function(e){return e.getId()}).join(", ");throw Error(e.getText("MSG_DEPENDENT_CHANGE_ERROR",[t.change.getId(),n]))})}return e})};y.revert=function(e){var t=m.getAppComponentForSelector(e.element||{});var a=[];var r={modifier:n,appComponent:t};if(!Array.isArray(e.change)){return l.revertChangeOnControl(e.change,e.element,r)}var c=e.change.slice(0).reverse();return c.reduce(function(t,n){return t.then(function(){return l.revertChangeOnControl(n,e.element,r).then(function(e){a.unshift(e)})})},Promise.resolve()).then(function(){return a})};y.getChangeHandler=function(e){var t=e.controlType||e.modifier.getControlType(e.element);return h.getChangeHandler(e.changeType,t,e.element,e.modifier,e.layer)};return y});
//# sourceMappingURL=ChangesWriteAPI.js.map