/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Versions","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/base/Log"],function(e,n,t,r,i,a,o,s,p,c,h,l,u){"use strict";function f(e,n,t){return Promise.resolve().then(function(){if(t.length!==0){t.reverse();return a.revertMultipleChanges(t,{appComponent:e,modifier:h,flexController:this})}return undefined}.bind(this)).then(function(){if(e){var r=e.getModel(c.getVariantModelName());if(r){if(!n){o.update({parameters:[],updateURL:true,updateHashEntry:true,model:r})}}}return t})}var g=function(e){this._oChangePersistence=undefined;this._sComponentName=e||"";if(this._sComponentName){this._oChangePersistence=t.getChangePersistenceForComponent(this._sComponentName)}};g.prototype.setVariantSwitchPromise=function(e){this._oVariantSwitchPromise=e};g.prototype.waitForVariantSwitch=function(){this._oVariantSwitchPromise||=Promise.resolve();return this._oVariantSwitchPromise};function d(n,t,r,i,a){var o=C(n,i);if(!o){return[]}a.push(n);var s=n.getId();var p=t[s]&&t[s].dependencies||[];for(var c=0,h=p.length;c<h;c++){var l=e.getChangeFromChangesMap(r,p[c]);o=d(l,t,r,i,a);if(o.length===0){a=[];break}delete t[s]}return a}function C(e,n){var t=e.getDependentControlSelectorList();t.push(e.getSelector());return!t.some(function(e){return!h.bySelector(e,n)})}g.prototype.waitForChangesToBeApplied=function(e){var n=e.map(function(e){return this._waitForChangesToBeApplied(e)}.bind(this));return Promise.all(n).then(function(){return undefined})};g.prototype._waitForChangesToBeApplied=async function(n){function t(e){return!e.isCurrentProcessFinished()&&(n.changeTypes.length===0||n.changeTypes.includes(e.getChangeType()))}const r=n.selector.id&&l.getElementById(n.selector.id)||n.selector;const i=n.selector.appComponent||e.getAppComponentForControl(r);await p.initialize({componentId:i.getId()});n.changeTypes||=[];var a=this._oChangePersistence.getDependencyMapForComponent();var o=[];var s=Object.assign({},a.mDependencies);var{mChanges:c}=a;var h=c[r.getId()]||[];var u=h.filter(t);var f=[];u.forEach(function(e){var n=d(e,s,a.mChanges,i,[]);n.forEach(function(e){if(f.indexOf(e)===-1){f.push(e)}})});f.forEach(function(e){o=o.concat(e.addChangeProcessingPromises())},this);o.push(this.waitForVariantSwitch());return Promise.all(o)};g.prototype._removeOtherLayerChanges=function(e,t,r){if(r&&t){var i=Object.values(n).filter(function(e){return e!==t});return this.removeDirtyChanges(i,e,undefined,undefined,undefined,true)}return Promise.resolve()};g.prototype.saveAll=function(e,t,i,a,o,s){var p;var c;if(i){var h=r.getVersionsModel({reference:this._sComponentName,layer:n.CUSTOMER});p=h.getProperty("/persistedVersion");c=h.getProperty("/draftFilenames")}return this._removeOtherLayerChanges(e,a,o).then(this._oChangePersistence.saveDirtyChanges.bind(this._oChangePersistence,e,t,undefined,p,c,s,a)).then(function(e){if(i&&e&&e.response){var n=e.response;var t=[];if(Array.isArray(n)){n.forEach(function(e){t.push(e.fileName)});[n]=n}r.onAllChangesSaved({reference:n.reference,layer:n.layer,draftFilenames:t})}return e})};g.prototype.resetChanges=function(e,n,t,r,i){return this._oChangePersistence.resetChanges(e,n,r,i).then(f.bind(this,t,undefined))};g.prototype.removeDirtyChanges=function(e,n,t,r,i,a){return this._oChangePersistence.removeDirtyChanges(e,n,t,r,i).then(f.bind(this,n,a))};g.prototype.applyVariantChanges=function(n,t){var r;return n.reduce(function(e,n){return e.then(function(){var e={modifier:h,appComponent:t};this._oChangePersistence._addRunTimeCreatedChangeToDependencyMap(t,n);r=e.modifier.bySelector(n.getSelector(),t);if(r){return i.applyChangeOnControl(n,r,e)}u.error("A flexibility change tries to change a nonexistent control.");return undefined}.bind(this))}.bind(this),e.FakePromise?new e.FakePromise:Promise.resolve())};g.prototype.saveSequenceOfDirtyChanges=async function(e,n){const t=e||this._oChangePersistence.getDirtyChanges();const r=await this._oChangePersistence.saveDirtyChanges(n,false,t);if(r?.response?.length){var i=r.response.map(e=>e.fileName);t.forEach(function(e){if(i.includes(e.getId())){e.setState(s.LifecycleState.PERSISTED)}});p.getFlexObjectsDataSelector().checkUpdate({reference:this._sComponentName})}return r};return g});
//# sourceMappingURL=FlexController.js.map