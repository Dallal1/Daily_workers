/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/merge","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/Utils"],(e,t,n,o,i,a,r,s,l,c,g,f)=>{"use strict";const p={};function u(e,t){if(t.getSelector().name!==e.extensionPointName){return false}return i.filterChangeByView(e,t)}function d(e,t){if(t.fragmentId){const n=e.getExtensionPointInfo&&e.getExtensionPointInfo();if(n){return t.fragmentId!==n.fragmentId}return true}return false}function C(e,n,o){let i=e.getSelector();if(n.closestAggregationBindingCarrier&&n.closestAggregationBinding){i=t(i,{id:n.closestAggregationBindingCarrier,idIsLocal:false});const a={id:n.targetControl.getId(),idIsLocal:false};if(o){e.originalSelectorToBeAdjusted=a}else{e.setDependentSelectors({originalSelector:a})}e.setContent({boundAggregation:n.closestAggregationBinding})}else{i=t(i,{id:n.targetControl.getId(),idIsLocal:false})}e.setSelector(i)}function m(e){const t=a.createUIChange(e.changeSpecificData);return c.getChangeHandler(t.getChangeType(),e.controlType,e.selector,o,t.getLayer()).then(n=>n.completeChangeContent(t,e.changeSpecificData,{modifier:o,appComponent:e.appComponent,view:f.getViewForControl(e.selector)})).then(()=>{t.setState(r.LifecycleState.NEW);return t})}function h(e){if(e.selector.name&&e.selector.view){const t=f.getAppComponentForSelector(e.selector.view);const n=e.selector.appId||l.getFlexReferenceForControl(t);e.appComponent=t;e.changeSpecificData.reference=n;e.changeSpecificData.selector={name:e.selector.name,viewSelector:o.getSelector(e.selector.view.getId(),t)};return m(e)}return undefined}p.getChangesForExtensionPoint=function(e,t){if(!t.extensionPointName){n.error("Missing name from extension point info!");return Promise.resolve([])}return e.getChangesForComponent().then(function(e){return e.filter(u.bind(undefined,t))})};p.enhanceExtensionPointChanges=function(t,n){t.extensionPointName=n.name;const o=g.getChangePersistenceForControl(n.targetControl);return p.getChangesForExtensionPoint(o,t).then(function(i){const a=[];i.forEach(function(i){if(i.isInInitialState()&&!(i.getExtensionPointInfo&&i.getExtensionPointInfo())){i.setExtensionPointInfo(n);C(i,n,false);if(s.isInitialized(t)){o.addChangeAndUpdateDependencies(t.appComponent,i)}}else if(d(i,n)){const r=i.convertToFileContent();const s=i.getContent();const l=e(r,["dependentSelector","fileName","selector","content","adaptationId"]);Object.keys(s).forEach(function(e){l[e]=s[e]});l.support.sourceChangeFileName=i.getId()||"";a.push(h({changeSpecificData:l,selector:{view:n.view,name:n.name}}).then(function(e){C(e,n,true);e.setExtensionPointInfo(n);const r=e.getFlexObjectMetadata();r.moduleName=i.getFlexObjectMetadata().moduleName;e.setFlexObjectMetadata(r);e.setCreation(i.getCreation());o.addChangeAndUpdateDependencies(t.appComponent,e,i);a.push(e)}))}});return Promise.all(a).then(function(){return i})})};return p});
//# sourceMappingURL=ExtensionPointState.js.map