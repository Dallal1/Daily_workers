/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/strings/formatMessage","sap/ui/core/Element","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/changes/UIChangesState","sap/ui/fl/Utils"],function(e,n,r,t,a,o,i,s,l){"use strict";var c=l.FakePromise?new l.FakePromise:Promise.resolve();function f(r,t,a,o){var i=t.join(" ");i=n(i,a);e[r](i,o||"")}function u(e,n){var r=e.getSelector&&e.getSelector();if(!r||!r.id&&!r.name){return Promise.reject(Error("No selector in change found or no selector ID."))}function t(e){if(l.indexOfObject(n.failedSelectors,e)>-1){throw Error("A change depending on that control already failed, so the current change is skipped")}}return n.modifier.bySelectorTypeIndependent(r,n.appComponent,n.view).then(function(a){if(!a){throw Error("A flexibility change tries to change a nonexistent control.")}t(r);var o=e.getDependentControlSelectorList();o.forEach(function(e){var r=n.modifier.bySelector(e,n.appComponent,n.view);if(!r){throw new Error("A dependent selector control of the flexibility change is not available.")}t(e)});return a})}function d(e){return e.modifier.targets==="xmlTree"}function p(e,n,r){var t=o.getControlIfTemplateAffected(n,e,r).control;var i=r.modifier;var l=t&&!!a.getAppliedCustomDataValue(t,n,i);var c=t&&a.hasChangeApplyFinishedCustomData(t,n,i);var f=n.isApplyProcessFinished();if(f&&!c){if(!d(r)){s.copyDependenciesFromCompleteDependencyMap(n,r.appComponent)}n.setInitialApplyState()}else if(!f&&c){if(l){n.setRevertData(a.getParsedRevertDataFromCustomData(t,n,i));n.markSuccessful()}else{n.markFailed()}}else if(f&&c){n.markSuccessful()}}function g(e,n){var r;if(d(n)&&e.getJsOnly()){r="Change cannot be applied in XML. Retrying in JS."}if(r){e.setInitialApplyState();throw Error(r)}}function h(e,n,t,o){return Promise.resolve().then(function(){if(t instanceof r){n.control=t}if(n.control){return o.modifier.updateAggregation(n.originalControl,e.getContent().boundAggregation)}return undefined}).then(function(){return a.addAppliedCustomData(n.control,e,o,d(o))}).then(function(){var n={success:true};e.markSuccessful(n);return n})}function m(e,n,r,t){var o=d(t);var i={success:false,error:e};var s=n.getId();var l="Change ''{0}'' could not be applied.";var c=e instanceof Error;var u=a.getCustomDataIdentifier(false,c,o);switch(u){case a.notApplicableChangesCustomDataKey:f("info",[l,e.message],[s]);break;case a.failedChangesCustomDataKeyXml:f("warning",[l,"Merge error detected while processing the XML tree."],[s],e.stack);break;case a.failedChangesCustomDataKeyJs:f("error",[l,"Merge error detected while processing the JS control tree."],[s],e.stack);break;default:}return a.addFailedCustomData(r.control,n,t,u).then(function(){if(o){n.setInitialApplyState()}else{n.markFailed(i)}return i})}function v(n,r){var t=r.getChangeType();var a=r.getSelector().id;var o=`${r.getNamespace()+r.getId()}.${r.getFileType()}`;var i="A flexibility change could not be applied.";i+="\nThe displayed UI might not be displayed as intedend.";if(n.message){i+=`\n   occurred error message: '${n.message}'`}i+=`\n   type of change: '${t}'`;i+=`\n   LRep location of the change: ${o}`;i+=`\n   id of targeted control: '${a}'.`;e.warning(i,undefined,"sap.ui.fl.apply._internal.changes.Applier")}function C(e,n,r){var a={appComponent:r,modifier:t};var o=t.bySelector(e.originalSelectorToBeAdjusted,r);var i=n.getBindingInfo(e.getContent().boundAggregation).template;if(o.getParent()){var s=[];var l=o;do{s.push({aggregation:l.sParentAggregationName,index:l.getParent().getAggregation(l.sParentAggregationName).indexOf(l)});l=l.getParent()}while(l.getParent());s.reverse();s.forEach(function(e){i=i.getAggregation(e.aggregation)[e.index]})}e.addDependentControl(i,"originalSelector",a)}function y(e,n,r){var t=e.findIndex(function(e){return e.handler===n});if(t<0){t=e.length;e.push({handler:n,controls:[]})}if(!e[t].controls.includes(r)){e[t].controls.push(r)}}var A={addPreConditionForInitialChangeApplying(e){c=c.then(function(){return e})},applyChangeOnControl(e,n,r){var t=o.getControlIfTemplateAffected(e,n,r);var a=r.changeHandler?Promise.resolve(r.changeHandler):o.getChangeHandler(e,t,r);return a.then(function(n){g(e,r);return n}).then(function(n){if(e.hasApplyProcessStarted()){return e.addPromiseForApplyProcessing().then(function(n){e.markSuccessful();return n})}else if(!e.isApplyProcessFinished()){return(l.FakePromise?new l.FakePromise:Promise.resolve()).then(function(){e.startApplying();return n.applyChange(e,t.control,r)}).then(function(n){return h(e,t,n,r)}).catch(function(n){return m(n,e,t,r)})}var a={success:true};e.markSuccessful(a);return a}).catch(function(e){return{success:false,error:e}})},applyAllChangesForControl(e,n,r){const a=s.getLiveDependencyMap(n);var o=r.getId();var f=a.mChanges[o]||[];var u={modifier:t,appComponent:e,view:l.getViewForControl(r)};f.forEach(function(e){p(r,e,u);if(!e.isApplyProcessFinished()&&!e._ignoreOnce){e.setQueuedForApply()}});c=c.then(function(n,r){var t=[];var o=n.getId();var s=a.mChanges[o]||[];var c;if(a.mControlsWithDependencies[o]){i.removeControlsDependencies(a,o);c=true}s.forEach(function(s){if(s.originalSelectorToBeAdjusted){C(s,n,e);delete s.originalSelectorToBeAdjusted}if(s._ignoreOnce){delete s._ignoreOnce}else if(s.isApplyProcessFinished()){i.resolveDependenciesForChange(a,s.getId(),o)}else if(!a.mDependencies[s.getId()]){t.push(function(){return A.applyChangeOnControl(s,n,r).then(function(){i.resolveDependenciesForChange(a,s.getId(),o)})})}else{var l=A.applyChangeOnControl.bind(A,s,n,r);i.addChangeApplyCallbackToDependency(a,s.getId(),l)}});if(s.length||c){return l.execPromiseQueueSequentially(t).then(function(){return i.processDependentQueue(a,e,o)})}return undefined}.bind(null,r,u));return c},applyAllChangesForXMLView(n,r){if(!Array.isArray(r)){var t=`No list of changes was passed for processing the flexibility on view: ${n.view}.`;e.error(t,undefined,"sap.ui.fl.apply._internal.changes.Applier");r=[]}var a=[];n.failedSelectors=[];return r.reduce(function(e,r){var t;return e.then(u.bind(null,r,n)).then(function(e){t=e;var a=o.getControlIfTemplateAffected(r,t,n);return o.getChangeHandler(r,a,n)}).then(function(e){n.changeHandler=e;r.setQueuedForApply();p(t,r,n);if(!r.isApplyProcessFinished()){if(typeof n.changeHandler.onAfterXMLChangeProcessing==="function"){y(a,n.changeHandler,t)}return A.applyChangeOnControl(r,t,n)}return{success:true}}).then(function(e){if(!e.success){throw Error(e.error)}}).catch(function(e){r.getDependentSelectorList().forEach(function(e){if(l.indexOfObject(n.failedSelectors,e)===-1){n.failedSelectors.push(e)}});v(e,r)})},l.FakePromise?new l.FakePromise:Promise.resolve()).then(function(){delete n.failedSelectors;a.forEach(function(r){r.controls.forEach(function(t){try{r.handler.onAfterXMLChangeProcessing(t,n)}catch(n){e.error("Error during onAfterXMLChangeProcessing",n)}})});return n.view})}};return A});
//# sourceMappingURL=Applier.js.map