/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/values","sap/base/util/restricted/_omit","sap/base/Log","sap/ui/base/ManagedObject","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/dt/ElementUtil","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/Utils","sap/ui/fl/changeHandler/common/ChangeCategories","sap/ui/rta/util/changeVisualization/ChangeStates"],function(e,t,n,i,o,s,r,a,c,g){"use strict";const d=i.extend("sap.ui.rta.util.changeVisualization.ChangeIndicatorRegistry",{metadata:{properties:{changeCategories:{type:"object",defaultValue:[]},rootControlId:{type:"string"}}},constructor:function(...e){i.prototype.constructor.apply(this,e);this._oRegisteredChanges={};this._oChangeIndicators={}}});d.prototype.exit=function(){this.reset()};d.prototype.getAllRegisteredChanges=function(){return e(this._oRegisteredChanges||{}).map(function(e){return Object.assign({},e)})};d.prototype.getRegisteredChangeIds=function(){return Object.keys(this._oRegisteredChanges||{})};d.prototype.getRegisteredChange=function(e){return this._oRegisteredChanges[e]&&Object.assign({},this._oRegisteredChanges[e])};d.prototype.getSelectorsWithRegisteredChanges=function(){const n={};let i;function o(e,o,s,r){if(n[e]===undefined){n[e]=[]}n[e].push(Object.assign({id:s.change.getId(),dependent:r,affectedElementId:o||i,displayElementsKey:s.visualizationInfo.displayElementIds.toString(),descriptionPayload:s.visualizationInfo.descriptionPayload||{}},t(s,["visualizationInfo"])));i=o||i}e(this._oRegisteredChanges).forEach(function(e){e.visualizationInfo.displayElementIds.forEach(function(t,n){o(t,e.visualizationInfo.affectedElementIds[n],e,false)})});return n};d.prototype.getRelevantChangesWithSelector=function(){const e=this.getSelectorsWithRegisteredChanges();let t=[];Object.keys(e).forEach(function(n){const i=e[n].filter(function(e){return!e.dependent});t=t.concat(i)});return t};d.prototype.getChangeIndicator=function(e){return this._oChangeIndicators[e]};d.prototype.getChangeIndicators=function(){return e(this._oChangeIndicators||{})};d.prototype.registerChange=function(e,t,n){const i=a.getAppComponentForControl(s.getElementInstance(this.getRootControlId()));return l(e,i).then(function(i){const o=this.getChangeCategories();let s;if(t==="settings"&&Object.keys(o).includes(i.descriptionPayload.category)){s=i.descriptionPayload.category}else{s=Object.keys(o).find(function(e){return o[e].includes(t)});s||=c.OTHER}let r;let a=[];if(n){a=n.getData().draftFilenames}if(e.getState()==="NEW"){r=g.getDraftAndDirtyStates()}else if(a&&a.includes(e.getId())){r=[g.DRAFT]}else{r=[g.ALL]}this._oRegisteredChanges[e.getId()]={change:e,commandName:t,changeCategory:s,changeStates:r,visualizationInfo:i}}.bind(this))};function l(e,t){function n(e){if(!e){return undefined}return e.map(function(e){const n=typeof e.getId==="function"?e:o.bySelector(e,t);return n&&n.getId()}).filter(Boolean)}return u(t,e).then(function(t){const i=t||{};const o=e.getSelector&&e.getSelector()&&[e.getSelector()];const s=i.affectedControls||o||[];const r=e.getOriginalSelector&&e.getOriginalSelector();const a=r?o:s;return{affectedElementIds:n(s),dependentElementIds:n(i.dependentControls)||[],displayElementIds:n(i.displayControls||n(a)),updateRequired:i.updateRequired,descriptionPayload:i.descriptionPayload||{}}})}function u(e,t){let i=t.getOriginalSelector&&t.getOriginalSelector();i||=t.getSelector&&t.getSelector();const s=o.bySelector(i,e);if(s){return r.getChangeHandler({changeType:t.getChangeType(),element:s,modifier:o,layer:t.getLayer()}).then(function(n){if(n&&typeof n.getChangeVisualizationInfo==="function"&&t.isSuccessfullyApplied&&t.isSuccessfullyApplied()){return n.getChangeVisualizationInfo(t,e)}return undefined}).catch(function(e){n.error(e);return undefined})}return Promise.resolve()}d.prototype.registerChangeIndicator=function(e,t){this._oChangeIndicators[e]=t};d.prototype.waitForIndicatorRendering=function(){return Promise.all(this.getChangeIndicators().map(e=>e.waitForRendering()))};d.prototype.reset=function(){Object.keys(this._oRegisteredChanges).forEach(function(e){this.removeRegisteredChange(e)}.bind(this));e(this._oChangeIndicators).forEach(function(e){e.destroy()});this._oChangeIndicators={}};d.prototype.removeRegisteredChange=function(e){delete this._oRegisteredChanges[e]};d.prototype.removeOutdatedRegisteredChanges=function(){this.getAllRegisteredChanges().forEach(function(e){if(e.visualizationInfo&&e.visualizationInfo.updateRequired){this.removeRegisteredChange(e.change.getId())}}.bind(this))};d.prototype.removeRegisteredChangesWithoutVizInfo=function(){this.getAllRegisteredChanges().forEach(function(e){if(e.visualizationInfo&&e.visualizationInfo.displayElementIds.length===0){this.removeRegisteredChange(e.change.getId())}}.bind(this))};return d});
//# sourceMappingURL=ChangeIndicatorRegistry.js.map