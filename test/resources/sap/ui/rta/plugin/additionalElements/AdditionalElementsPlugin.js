/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/Log","sap/ui/core/EventBus","sap/ui/core/IconPool","sap/ui/core/Lib","sap/ui/dt/OverlayRegistry","sap/ui/dt/OverlayUtil","sap/ui/fl/write/api/FieldExtensibility","sap/ui/rta/plugin/additionalElements/ActionExtractor","sap/ui/rta/plugin/additionalElements/AddElementsDialog","sap/ui/rta/plugin/additionalElements/AdditionalElementsAnalyzer","sap/ui/rta/plugin/additionalElements/AdditionalElementsUtils","sap/ui/rta/plugin/additionalElements/CommandBuilder","sap/ui/rta/plugin/Plugin","sap/ui/rta/Utils"],function(e,t,i,n,a,s,r,l,o,u,d,g,h,c,f){"use strict";var E=true;var m=false;function v(e,t){var i=t.responsibleElementOverlay.getParentAggregationOverlay().getAggregationName();return Object.keys(e).some(function(e){return e===i})}async function b(e){const t=e.getModel();if(t&&t.sServiceUrl){const e=await l.isServiceOutdated(t.sServiceUrl);if(e){l.setServiceValid(t.sServiceUrl);i.getInstance().publish("sap.ui.core.UnrecoverableClientStateCorruption","RequestReload",{})}}}async function p(e){await l.onControlSelected(e);const t=await l.isExtensibilityEnabled(e);if(t){await b(e);return l.getExtensionData(e)}return undefined}var _=c.extend("sap.ui.rta.plugin.additionalElements.AdditionalElementsPlugin",{constructor:function(...e){this._getMenuItemsPromise=Promise.resolve();const[t]=e;t.dialog=new u;c.apply(this,e)},metadata:{library:"sap.ui.rta",properties:{commandFactory:"object"},aggregations:{dialog:{type:"sap.ui.rta.plugin.additionalElements.AddElementsDialog",multiple:false}},associations:{},events:{}},_getRelevantOverlays(e){var t=r.findAllOverlaysInContainer(e,true);e.setRelevantOverlays(t);return t},getContextMenuText(e,t,i,n){var s;function r(){s=a.getResourceBundleFor("sap.ui.rta");return s.getText("CTX_ADD_ELEMENTS",[s.getText("MULTIPLE_CONTROL_NAME")])}if(i==="$$OnlyChildCustomField$$"){return r()}if(n){s=a.getResourceBundleFor("sap.ui.rta");return s.getText("CTX_ADD_ELEMENTS_WITH_SUBMENU")}var l=g.getParents(e,t,this);var u=o.getActionsOrUndef(e,t);i||=Object.keys(u)[0];var d=u[i];if(!d){return r()}d.aggregation=i;return g.getText("CTX_ADD_ELEMENTS",d,l.parent,E)},isAvailable(e,t){return e.every(function(e){return this._isEditableByPlugin(e,t)},this)},isEnabled(e,t,i){if(e.length>1){return false}if(this.getExtensibilityInfo(t)){return true}var n=this.getResponsibleElementOverlay(e[0]);var a;var s=false;if(t){a=n.getParentElementOverlay();if(a){s=true}}else{var r=o.getActionsOrUndef(t,n);var l=r[i];if(l&&(l.reveal&&l.reveal.elements.length>0||l.addViaDelegate)){s=true}}var u=this.getCachedElements(t);var d=!!(u&&u.length>0);s&&=d;return s},registerElementOverlay(...e){const[t]=e;var i=t.getElement().getModel();if(i){var n=i.getMetaModel();if(n&&n.loaded){n.loaded().then(function(){this.evaluateEditable([t],{onRegistration:true})}.bind(this))}}c.prototype.registerElementOverlay.apply(this,e)},_checkIfCreateFunctionIsAvailable(e){return!e||e&&e.content&&e.content.createFunction},showAvailableElements(e,i,n,r,l,u){var d=n[0];var c=g.getParents(e,d,this);var f=e&&d.getElement();var E;var m=[];return o.getActions(e,d,this,undefined,this.getDesignTime()).then(function(t){if(i==="$$OnlyChildCustomField$$"){return[]}E=t[i];return this.getAllElements(e,[c.responsibleElementOverlay],l,u)}.bind(this)).then(function(t){m=t;var i=this.getExtensibilityInfo(e);this.getDialog().setCustomFieldEnabled(!!i);if(i){this.getDialog().detachEvent("openCustomField",this._onOpenCustomField,this);this.getDialog().attachEvent("openCustomField",e,this._onOpenCustomField,this);this.getDialog().setCustomFieldButtonVisible(true);return this.getDialog().addExtensionData(i.extensionData)}return this.getDialog().setCustomFieldButtonVisible(false)}.bind(this)).then(function(){var e=m.filter(function(e){return e.aggregation===i})[0];var t=e?e.elements:[];this.getDialog().setElements(t);if(u){var n=a.getResourceBundleFor("sap.ui.rta");var o=n.getText("HEADER_ADDITIONAL_ELEMENTS_WITH_AGGREGATION",[u]);this.getDialog().setTitle(o)}else if(i||l){this._setDialogTitle(E||{},c.parent,l)}return this.getDialog().open().then(function(){var e=this.getDialog().getSelectedElements();return h.createCommands(c,f,E,r,e,i,this)}.bind(this)).then(function(){var e=s.getOverlay(f)||d;e.focus()}).catch(function(e){if(e instanceof Error){throw e}})}.bind(this)).catch(function(e){if(e instanceof Error){throw e}else{t.info("Service not up to date, skipping add dialog","sap.ui.rta")}})},_setDialogTitle(e,t,i){var n=g.getText("HEADER_ADDITIONAL_ELEMENTS",e,t,m,i);this.getDialog().setTitle(n)},_onOpenCustomField(e,t){var i=f.getRtaStyleClassName();return l.onTriggerCreateExtensionData(this.getExtensibilityInfo(t),i)},_isEditable(e,i){return Promise.all([this._isEditableCheck(i.sourceElementOverlay,true),this._isEditableCheck(i.sourceElementOverlay,false)]).then(function(e){return{asSibling:e[0],asChild:e[1]}}).catch(function(e){t.error(e)})},async _isEditableCheck(e,t){var i=g.getParents(t,e,this);if(!i.relevantContainerOverlay){return false}const n=await o.getActions(t,e,this,true,this.getDesignTime());await this._getMenuItemsPromise;this.clearCachedElements();return f.doIfAllControlsAreAvailable([e,i.parentOverlay],function(){var a=false;if(t){a=v(n,i)}else{a=Object.keys(n).some(function(e){if(n[e].addViaDelegate){a=this.checkAggregationsOnSelf(i.parentOverlay,"add",undefined,"delegate")}if(!a&&n[e].reveal){return true}return a}.bind(this))}a&&=this.hasStableId(e)&&this.hasStableId(i.parentOverlay);return a}.bind(this))},getAllElements(t,i){var n=i[0];var a=g.getParents(t,n,this);var s;var r=[];var l=false;var u=this.getCachedElements(t);if(u){return u}this.clearExtensibilityInfo(t);return o.getActions(t,n,this,undefined,this.getDesignTime()).then(function(t){e(t,function(e){s=t[e];s.aggregation=e;if(s.addViaDelegate){l=true}r.push({aggregation:e,elementPromises:[s.reveal?d.enhanceInvisibleElements(a.parent,s):Promise.resolve([]),s.addViaDelegate?d.getUnrepresentedDelegateProperties(a.parent,s.addViaDelegate):Promise.resolve([])]})});if(l){return p(a.parent)}return undefined}).then(function(e){this.setExtensibilityInfo(t,e)}.bind(this)).then(this._combineAnalyzerResults.bind(this,r)).then(function(e){this.setCachedElements(e,t);return e}.bind(this)).catch(function(e){throw e})},getMenuItems(e){var t=[];var i;this.clearCachedElements();this._getMenuItemsPromise=Promise.all([this.getAllElements(false,e),this.getAllElements(true,e)]).then(function(n){var a=n[0].length>0;var s=n[0].length>1;var r=n[1].length>0;var l=this.isAvailable(e,false);var o=this.isAvailable(e,true);if(o&&(!l||!a)){i=this._buildMenuItem("CTX_ADD_ELEMENTS_AS_SIBLING",true,e,n,false)}else if(!o&&l&&!s){i=this._buildMenuItem("CTX_ADD_ELEMENTS_AS_CHILD",false,e,n,false)}else if(!o&&l&&s){i=this._buildMenuItem("CTX_ADD_ELEMENTS_AS_CHILD",false,e,n,true)}else if(l&&o&&a&&r){i=this._buildMenuItem("CTX_ADD_ELEMENTS_CHILD_AND_SIBLING",false,e,n,true)}if(i){t.push(this.enhanceItemWithResponsibleElement(i,e,["addViaDelegate","reveal","custom"]))}return t}.bind(this));return this._getMenuItemsPromise},_buildMenuItem(e,t,i,n,a){var s;var r;var l;var o=i[0];if(t){var u=g.getParents(t,o,this);l=u.responsibleElementOverlay.getParentAggregationOverlay().getAggregationName()}else{var d=n[0].length===0&&n[1].length===0;l=d?"$$OnlyChildCustomField$$":n[0]&&n[0][0]&&n[0][0].aggregation}if(a){s=this._buildSubmenuItems(false,i,n[0]);if(e==="CTX_ADD_ELEMENTS_CHILD_AND_SIBLING"){s=s.concat(this._buildSubmenuItems(true,i,n[1]))}}else{r=function(e,t){return this.showAvailableElements(e,l,t)}.bind(this,t)}var h={id:e,text:this.getContextMenuText.bind(this,t,o,l,a),enabled:a||function(e,t){return this.isEnabled(t,e,l)}.bind(this,t),rank:20,icon:"sap-icon://add",handler:r};if(a){h.submenu=s}return h},_buildSubmenuItems(e,t,i){var a=[];var s=e?"CTX_ADD_ELEMENTS_AS_SIBLING":"CTX_ADD_ELEMENTS_AS_CHILD";var r=0;n.registerFont({collectionName:"BusinessSuiteInAppSymbols",fontFamily:"BusinessSuiteInAppSymbols",fontURI:sap.ui.require.toUrl("sap/ushell/themes/base/fonts/"),lazy:true});function l(e,t,i){var n=e?i[0].getParentElementOverlay():i[0];var a=n.getDesignTimeMetadata();var s=a.getAggregationDisplayName(t,n.getElement());return s?s.singular:t}i.forEach(function(i){var n=i.aggregation;var o=l(e,n,t);var u={id:`${s}_${r}`,text:o,enabled:function(t){return this.isEnabled(t,e,n)}.bind(this),handler:function(e,t){return this.showAvailableElements(e,n,t,undefined,undefined,o)}.bind(this,e),icon:e?"sap-icon://BusinessSuiteInAppSymbols/icon-add-outside":"sap-icon://add"};a.push(this.enhanceItemWithResponsibleElement(u,t,["addViaDelegate","reveal","custom"]));r++}.bind(this));return a},_combineAnalyzerResults(e){var t=[];e.forEach(function(e){t.push(Promise.all(e.elementPromises).then(function(t){var i=t[0];var n=t[1];var a=i.concat(n);return{aggregation:e.aggregation,elements:a}}))});return Promise.all(t).then(function(e){return e.filter(function(e){var t=e&&e.elements;return t.length>0})})},clearCachedElements(){this._oCachedElements=undefined},setCachedElements(e,t){this._oCachedElements||={};this._oCachedElements[t?"asSibling":"asChild"]=e},getCachedElements(e){if(this._oCachedElements){return this._oCachedElements[e?"asSibling":"asChild"]}return undefined},clearExtensibilityInfo(e){if(this._oExtensibilityInfo){this._oExtensibilityInfo[e?"asSibling":"asChild"]=undefined}},setExtensibilityInfo(e,t){this._oExtensibilityInfo||={};this._oExtensibilityInfo[e?"asSibling":"asChild"]=t},getExtensibilityInfo(e){if(this._oExtensibilityInfo){return this._oExtensibilityInfo[e?"asSibling":"asChild"]}return undefined},exit(...e){this.getDialog().destroy();if(c.prototype.exit){c.prototype.exit.apply(this,e)}}});return _});
//# sourceMappingURL=AdditionalElementsPlugin.js.map