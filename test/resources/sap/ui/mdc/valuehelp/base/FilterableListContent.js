/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Lib","sap/ui/mdc/util/loadModules","sap/ui/mdc/valuehelp/base/ListContent","sap/ui/mdc/condition/Condition","sap/ui/mdc/enums/ConditionValidated","sap/ui/mdc/enums/OperatorName","sap/ui/mdc/util/Common","sap/m/p13n/enums/PersistenceMode","sap/m/p13n/Engine","sap/base/util/merge","sap/ui/mdc/p13n/StateUtil","sap/ui/mdc/condition/FilterOperatorUtil","sap/base/Log"],(e,t,i,r,n,o,s,l,a,c,h,u,d)=>{"use strict";const p=i.extend("sap.ui.mdc.valuehelp.base.FilterableListContent",{metadata:{library:"sap.ui.mdc",properties:{filterFields:{type:"string",defaultValue:""},keyPath:{type:"string",defaultValue:""},descriptionPath:{type:"string",defaultValue:""},group:{type:"string",defaultValue:""}},aggregations:{filterBar:{type:"sap.ui.mdc.filterbar.vh.FilterBar",multiple:false},_defaultFilterBar:{type:"sap.ui.mdc.filterbar.vh.FilterBar",multiple:false,visibility:"hidden"}},associations:{},events:{}}});p.prototype.init=function(){i.prototype.init.apply(this,arguments);this._oResourceBundle=e.getResourceBundleFor("sap.ui.mdc");this._oObserver.observe(this,{aggregations:["_defaultFilterBar","filterBar"]});this._oObserver.observe(this,{properties:["filterFields"]});a.getInstance().defaultProviderRegistry.attach(this,l.Transient);this.resetListBinding()};p.prototype.resetListBinding=function(){return this._addPromise("listBinding")};p.prototype.awaitListBinding=function(){return this._retrievePromise("listBinding")};p.prototype.resolveListBinding=function(){const e=this.getListBinding();if(e){this._resolvePromise("listBinding",e);this._updateBasicSearchField();return e}};p.prototype.handleFilterValueUpdate=function(e){if((this.isContainerOpening()||this.isContainerOpen())&&this._bContentBound){Promise.resolve(this.applyFilters()).finally(function(){i.prototype.handleFilterValueUpdate.apply(this,arguments)}.bind(this))}};p.prototype.applyFilters=function(){};p.prototype._prettyPrintFilters=function(e){let t;if(!e){return""}if(Array.isArray(e)){t="";e.forEach(function(e,i,r){t+=this._prettyPrintFilters(e);if(r.length-1!=i){t+=" or "}},this);return"("+t+")"}else if(e._bMultiFilter){t="";const{bAnd:i}=e;e.aFilters.forEach(function(e,r,n){t+=this._prettyPrintFilters(e);if(n.length-1!=r){t+=i?" and ":" or "}},this);return"("+t+")"}else{t=e.sPath+" "+e.sOperator+" '"+e.oValue1+"'";if(e.sOperator==="BT"){t+="...'"+e.oValue2+"'"}return t}};p.prototype.getItemFromContext=function(e,t){const i=t&&t.keyPath||this.getKeyPath();const r=t&&t.descriptionPath||this.getDescriptionPath();let n;let o;if(!i){throw new Error("KeyPath missing")}if(e){n=i?e.getProperty(i):undefined;o=r?e.getProperty(r):undefined}if(n===null||n===undefined){return false}const s=this.createConditionPayload([n,o],e);return{key:n,description:o,payload:s}};p.prototype.createConditionPayload=function(e,t){let i;const r=this.getValueHelpDelegate();if(r){const n=this.getValueHelpInstance();i={};i=r.createConditionPayload(n,this,e,t)}return i};p.prototype._isContextSelected=function(e,t){return!!e&&!!this._findConditionsForContext(e,t).length};p.prototype._findConditionsForContext=function(e,t){const i=this.isValueHelpDelegateInitialized()&&this.getValueHelpDelegate();if(e&&i){if(i.isFilterableListItemSelected){d.warning("MDC.ValueHelp","Delegate method 'isFilterableListItemSelected' is deprecated, please implement 'findConditionsForContext' instead.");const r=i.isFilterableListItemSelected(this.getValueHelpInstance(),this,{getBindingContext:function(){return e}},t);if(r){const i=this.getItemFromContext(e);const r=i&&this.createCondition(i.key,i.description,i.payload);return t.filter(e=>u.compareConditions(e,r))}return[]}return i.findConditionsForContext(this.getValueHelpInstance(),this,e,t)}return[]};p.prototype._createDefaultFilterBar=function(){return t(["sap/ui/mdc/filterbar/vh/FilterBar"]).then(e=>{if(this.isDestroyStarted()){return null}const t=e[0];const i=new t(this.getId()+"-FB",{liveMode:false,showGoButton:true});this.setAggregation("_defaultFilterBar",i,true);return i})};p.prototype._handleSearch=function(e){const t=e.getSource();this._setLocalFilterValue(t.getSearch());this.applyFilters()};p.prototype._updateBasicSearchField=function(){const e=this.getActiveFilterBar();if(e){const i=e.getBasicSearchField();let r=this.isSearchSupported();let n="$search";if(!this.isPropertyInitial("filterFields")){n=this.getFilterFields();r=!!n}if(!i&&r){if(!this._oSearchField){return t(["sap/ui/mdc/FilterField"]).then(t=>{if(!e.isDestroyed()){const e=t[0];this._oSearchField=new e(this.getId()+"-search",{conditions:"{$filters>/conditions/"+n+"}",propertyKey:n,placeholder:"{$i18n>filterbar.SEARCH}",label:"{$i18n>filterbar.SEARCH}",maxConditions:1,width:"50%"});this._oSearchField._bCreatedByValueHelp=true;this._updateBasicSearchField()}})}e.setBasicSearchField(this._oSearchField);i.setConditions([])}else if(i){if(r){}else if(i._bCreatedByValueHelp){e.setBasicSearchField()}}}};p.prototype.onContainerClose=function(){this._setLocalFilterValue(undefined)};p.prototype.getActiveFilterBar=function(){return this.getFilterBar()||this.getAggregation("_defaultFilterBar")};p.prototype.observeChanges=function(e){if(e.object==this){let t;if(["_defaultFilterBar","filterBar"].indexOf(e.name)!==-1){t=e.child;let i;if(e.mutation==="insert"){this._updateBasicSearchField();this._assignCollectiveSearchSelect();if(e.name!=="_defaultFilterBar"||!this.getFilterBar()){t.attachSearch(this._handleSearch,this)}if(e.name==="filterBar"){i=this.getAggregation("_defaultFilterBar");if(i){i.detachSearch(this._handleSearch,this)}}}else{const r=t.getBasicSearchField();if(r&&r._bCreatedByValueHelp){t.setBasicSearchField()}t.detachSearch(this._handleSearch,this);if(e.name==="filterBar"){i=this.getAggregation("_defaultFilterBar");if(i){i.attachSearch(this._handleSearch,this)}else{this._createDefaultFilterBar()}}}}if(e.name==="filterFields"){this._updateBasicSearchField()}}i.prototype.observeChanges.apply(this,arguments)};p.prototype.getCollectiveSearchKey=function(){return this._oCollectiveSearchSelect&&this._oCollectiveSearchSelect.getSelectedItemKey()};p.prototype.getListBindingInfo=function(){throw new Error("FilterableListContent: Every filterable listcontent must implement this method.")};p.prototype._getListItemBindingContext=function(e){const t=this.getListBindingInfo().model;return e&&e.getBindingContext(t)};p.prototype.getInitialFocusedControl=function(){return this.getActiveFilterBar().getInitialFocusedControl()};p.prototype._getTypesForConditions=function(e){const t=this.getValueHelpDelegate();const i=this.getValueHelpInstance();return t?t.getTypesForConditions(i,this,e):{}};p.prototype.getFormattedTitle=function(e){let t=i.prototype.getFormattedTitle.apply(this,arguments);if(!t){t=this._oResourceBundle.getText(e?"valuehelp.SELECTFROMLIST":"valuehelp.SELECTFROMLISTNONUMBER",[e])}return t};p.prototype.getFormattedShortTitle=function(){let e=this.getShortTitle();if(!e){e=this._oResourceBundle.getText("valuehelp.SELECTFROMLIST.Shorttitle")}return e};p.prototype.getFormattedTokenizerTitle=function(e){let t=this.getTokenizerTitle();if(!t){t=this._oResourceBundle.getText("valuehelp.SELECTFROMLIST.TokenizerTitle"+(e===0?"NoCount":""),[e])}return t};p.prototype.isSearchSupported=function(){if(!this.isPropertyInitial("filterFields")){const e=this.getFilterFields();if(e!=="$search"){return!!e}}return!!this.isValueHelpDelegateInitialized()&&!!this.getValueHelpDelegate()?.isSearchSupported(this.getValueHelpInstance(),this,this.getListBinding())};p.prototype.setCollectiveSearchSelect=function(e){this._oCollectiveSearchSelect=e;this._assignCollectiveSearchSelect()};p.prototype._assignCollectiveSearchSelect=function(){const e=this.getActiveFilterBar();if(e.setCollectiveSearch){e.setCollectiveSearch(this._oCollectiveSearchSelect)}};p.prototype.onBeforeShow=function(e){if(e){this._updateBasicSearchField();const t=this.getValueHelpDelegate();return Promise.resolve(t&&t.getFilterConditions(this.getValueHelpInstance(),this)).then(t=>{this._oInitialFilterConditions=t;const i=this.getActiveFilterBar();if(i){let t="$search";if(!this.isPropertyInitial("filterFields")){t=this.getFilterFields()}const r=c({},this._oInitialFilterConditions);const n=Promise.resolve(!r[t]&&h.retrieveExternalState(i).then(n=>{if(e){f(r,t,this.getSearch());return h.diffState(i,n,{filter:r})}})).then(e=>h.applyExternalState(i,e));return n.then(()=>i.awaitPendingModification())}})}return undefined};p.prototype._fireSelect=function(e){const t=this.getValueHelpDelegate();const i=this.getValueHelpInstance();const r=t&&t.modifySelectionBehaviour?t.modifySelectionBehaviour(i,this,e):e;if(r){this.fireSelect(r)}};p.prototype.exit=function(){a.getInstance().defaultProviderRegistry.detach(this);s.cleanup(this,["_oCollectiveSearchSelect","_oInitialFilterConditions"]);if(this._oSearchField&&!this._oSearchField.getParent()){this._oSearchField.destroy();delete this._oSearchField}i.prototype.exit.apply(this,arguments)};p.prototype.getCount=function(e,t){const r=this.isValueHelpDelegateInitialized()&&this.getValueHelpDelegate();const n=r&&this.getValueHelpInstance();return r&&r.getCount?r.getCount(n,this,e,t):i.prototype.getCount.apply(this,arguments)};p.prototype._getLocalFilterValue=function(){const e=this.getParent();return e&&e.getLocalFilterValue()};p.prototype._setLocalFilterValue=function(e){const t=this.getParent();return t&&t.setLocalFilterValue(e)};p.prototype.getSearch=function(){const e=this._getLocalFilterValue();if(typeof e!=="undefined"){return e}return this.getFilterValue()};p.prototype.getSelectableConditions=function(){return this.getConditions().filter(e=>e.validated===n.Validated)};function f(e,t,i){e[t]=i?[r.createCondition(o.Contains,[i],undefined,undefined,n.NotValidated)]:[];return}return p});
//# sourceMappingURL=FilterableListContent.js.map